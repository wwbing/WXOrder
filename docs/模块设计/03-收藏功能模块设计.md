# 收藏功能模块设计文档

> 模块编号：03
> 优先级：P1（第二阶段）
> 预估工作量：1天

---

## 1. 模块概述

### 1.1 功能范围
- 收藏/取消收藏菜品
- 查看我的收藏列表
- 从收藏夹快速点餐
- 查看菜品被收藏次数

### 1.2 模块依赖
- 用户与家庭模块
- 菜单管理模块

---

## 2. 数据库设计

### 2.1 favorites（收藏表）

```javascript
// 云开发数据库集合名称：favorites

{
  "_id": "ObjectId",
  "user_openid": "用户openid",        // 收藏者
  "menu_item_id": "菜品ID",
  "family_id": "家庭ID",
  "created_at": "Date"
}

// 索引设计
db.favorites.createIndex({ "user_openid": 1, "menu_item_id": 1 }, { unique: true })
db.favorites.createIndex({ "user_openid": 1, "created_at": -1 })
db.favorites.createIndex({ "menu_item_id": 1 })
db.favorites.createIndex({ "family_id": 1 })
```

---

## 3. 云函数设计

### 3.1 favorite 云函数

**文件路径**：`cloudfunctions/favorite/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()
const _ = db.command

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action, data } = event

  // 验证用户是否属于该家庭
  async function validateUserFamily(familyId) {
    const userRes = await db.collection('users').where({
      openid: wxContext.OPENID,
      family_id: familyId
    }).get()

    if (userRes.data.length === 0) {
      throw new Error('您不属于该家庭')
    }
    return userRes.data[0]
  }

  try {
    switch (action) {
      case 'list':
        // 获取我的收藏列表
        const { familyId, page = 1, pageSize = 20 } = data

        // 验证用户
        await validateUserFamily(familyId)

        // 查询收藏
        const favoritesRes = await db.collection('favorites')
          .where({
            user_openid: wxContext.OPENID,
            family_id: familyId
          })
          .orderBy('created_at', 'desc')
          .skip((page - 1) * pageSize)
          .limit(pageSize)
          .get()

        if (favoritesRes.data.length === 0) {
          return { success: true, data: { list: [], total: 0 } }
        }

        // 获取菜品详情
        const itemIds = favoritesRes.data.map(f => f.menu_item_id)
        const itemsRes = await db.collection('menu_items')
          .where({
            _id: _.in(itemIds),
            is_available: true
          })
          .get()

        // 关联数据
        const itemMap = {}
        itemsRes.data.forEach(item => {
          itemMap[item._id] = item
        })

        const list = favoritesRes.data.map(fav => ({
          ...fav,
          menu_item: itemMap[fav.menu_item_id] || null
        }))

        // 获取总数
        const totalRes = await db.collection('favorites')
          .where({
            user_openid: wxContext.OPENID,
            family_id: familyId
          })
          .count()

        return {
          success: true,
          data: {
            list,
            total: totalRes.total
          }
        }

      case 'add':
        // 添加收藏
        const { menuItemId, familyId: addFamilyId } = data

        // 验证用户
        await validateUserFamily(addFamilyId)

        // 验证菜品是否存在
        const itemRes = await db.collection('menu_items').doc(menuItemId).get()
        if (!itemRes.data) {
          throw new Error('菜品不存在')
        }

        // 检查是否已收藏
        const existingRes = await db.collection('favorites').where({
          user_openid: wxContext.OPENID,
          menu_item_id: menuItemId
        }).get()

        if (existingRes.data.length > 0) {
          throw new Error('您已收藏该菜品')
        }

        // 添加收藏
        await db.collection('favorites').add({
          data: {
            user_openid: wxContext.OPENID,
            menu_item_id: menuItemId,
            family_id: addFamilyId,
            created_at: new Date()
          }
        })

        return { success: true }

      case 'remove':
        // 取消收藏
        const { menuItemId: removeItemId } = data

        await db.collection('favorites').where({
          user_openid: wxContext.OPENID,
          menu_item_id: removeItemId
        }).remove()

        return { success: true }

      case 'check':
        // 检查是否已收藏
        const { menuItemId: checkItemId } = data

        const checkRes = await db.collection('favorites').where({
          user_openid: wxContext.OPENID,
          menu_item_id: checkItemId
        }).get()

        return {
          success: true,
          data: {
            isFavorited: checkRes.data.length > 0
          }
        }

      case 'batchCheck':
        // 批量检查收藏状态
        const { menuItemIds } = data

        const batchCheckRes = await db.collection('favorites')
          .where({
            user_openid: wxContext.OPENID,
            menu_item_id: _.in(menuItemIds)
          })
          .get()

        const favoritedIds = batchCheckRes.data.map(f => f.menu_item_id)

        return {
          success: true,
          data: {
            favoritedIds
          }
        }

      case 'getFavoriteCount':
        // 获取菜品被收藏次数
        const { menuItemId: countItemId } = data

        const countRes = await db.collection('favorites')
          .where({
            menu_item_id: countItemId
          })
          .count()

        return {
          success: true,
          data: {
            count: countRes.total
          }
        }

      case 'getBatchFavoriteCounts':
        // 批量获取收藏次数
        const { menuItemIds: countItemIds } = data

        const batchCountRes = await db.collection('favorites')
          .where({
            menu_item_id: _.in(countItemIds)
          })
          .groupBy('menu_item_id')
          .count()

        return {
          success: true,
          data: {
            counts: batchCountRes
          }
        }
    }
  } catch (err) {
    return { success: false, errMsg: err.message }
  }
}
```

---

## 4. 页面设计

### 4.1 页面结构

```
pages/
├── favorites/
│   └── index/              # 我的收藏页
└── components/
    └── favorite-btn/       # 收藏按钮组件
```

### 4.2 favorites/index 页面（我的收藏）

**文件**：`pages/favorites/index/index`

#### 功能说明

- 显示收藏的菜品列表
- 支持删除收藏
- 支持从收藏夹添加到点餐

#### WXML 结构
```xml
<view class="container">
  <view class="header">
    <text class="title">我的收藏</text>
    <text class="count">共 {{list.length}} 个菜品</text>
  </view>

  <view class="favorite-list" wx:if="{{list.length > 0}}">
    <view class="favorite-item" wx:for="{{list}}" wx:key="_id" wx:if="{{item.menu_item}}">
      <image
        class="item-image"
        src="{{item.menu_item.image_url || '/miniprogram/images/default-goods-image.png'}}"
        mode="aspectFill"
      />
      <view class="item-info">
        <text class="item-name">{{item.menu_item.name}}</text>
        <text class="item-price">¥{{item.menu_item.price / 100}}</text>
        <text class="item-desc">{{item.menu_item.description || '暂无描述'}}</text>
      </view>
      <view class="item-actions">
        <button class="action-btn add" catchtap="addToOrder" data-item="{{item.menu_item}}">+点餐</button>
        <button class="action-btn remove" catchtap="removeFavorite" data-id="{{item.menu_item_id}}">取消收藏</button>
      </view>
    </view>
  </view>

  <view class="empty-state" wx:if="{{list.length === 0 && !loading}}">
    <image class="empty-icon" src="/miniprogram/images/empty-favorite.png" />
    <text class="empty-text">暂无收藏</text>
    <text class="empty-hint">收藏喜欢的菜品，快速点餐</text>
    <button class="go-menu-btn" bindtap="goToMenu">去菜单看看</button>
  </view>
</view>
```

#### JS 逻辑
```javascript
const app = getApp()

Page({
  data: {
    familyId: '',
    list: [],
    loading: true
  },

  onShow() {
    this.loadFavorites()
  },

  async loadFavorites() {
    if (!app.globalData.familyId) {
      wx.showToast({ title: '请先加入家庭', icon: 'none' })
      return
    }

    this.setData({ loading: true })

    try {
      const res = await wx.cloud.callFunction({
        name: 'favorite',
        data: {
          action: 'list',
          familyId: app.globalData.familyId
        }
      })

      if (res.result.success) {
        this.setData({
          familyId: app.globalData.familyId,
          list: res.result.data.list
        })
      } else {
        wx.showToast({ title: res.result.errMsg, icon: 'none' })
      }
    } catch (err) {
      wx.showToast({ title: '加载失败', icon: 'none' })
    } finally {
      this.setData({ loading: false })
    }
  },

  async removeFavorite(e) {
    const { id } = e.currentTarget.dataset

    wx.showModal({
      title: '取消收藏',
      content: '确定取消收藏该菜品吗？',
      success: async (res) => {
        if (res.confirm) {
          try {
            const result = await wx.cloud.callFunction({
              name: 'favorite',
              data: {
                action: 'remove',
                menuItemId: id
              }
            })

            if (result.result.success) {
              wx.showToast({ title: '已取消收藏', icon: 'success' })
              this.loadFavorites()
            } else {
              wx.showToast({ title: result.result.errMsg, icon: 'none' })
            }
          } catch (err) {
            wx.showToast({ title: '操作失败', icon: 'none' })
          }
        }
      }
    })
  },

  addToOrder(e) {
    const { item } = e.currentTarget.dataset
    // 跳转到点餐页面，并携带菜品信息
    const encodedItem = encodeURIComponent(JSON.stringify(item))
    wx.navigateTo({
      url: `/pages/ordering/select?presetItem=${encodedItem}`
    })
  },

  goToMenu() {
    wx.switchTab({ url: '/pages/menu/index' })
  }
})
```

### 4.3 favorite-btn 组件（收藏按钮）

**文件**：`components/favorite-btn/index`

#### 功能说明
- 显示收藏状态
- 点击切换收藏状态
- 支持多种尺寸

#### WXML 结构
```xml
<view class="favorite-btn {{size}} {{isFavorited ? 'favorited' : ''}}" bindtap="toggle">
  <image class="icon" src="{{isFavorited ? '/miniprogram/images/icons/heart-filled.png' : '/miniprogram/images/icons/heart-outline.png'}}" />
</view>

<wxs module="utils">
module.exports = {
}
</wxs>
```

#### JS 逻辑
```javascript
Component({
  properties: {
    menuItemId: {
      type: String,
      value: ''
    },
    size: {
      type: String,
      value: 'normal' // small, normal, large
    },
    showCount: {
      type: Boolean,
      value: false
    }
  },

  data: {
    isFavorited: false,
    count: 0
  },

  lifetimes: {
    attached() {
      this.checkFavoriteStatus()
    }
  },

  methods: {
    async checkFavoriteStatus() {
      if (!this.data.menuItemId) return

      try {
        const res = await wx.cloud.callFunction({
          name: 'favorite',
          data: {
            action: 'check',
            menuItemId: this.data.menuItemId
          }
        })

        if (res.result.success) {
          this.setData({ isFavorited: res.result.data.isFavorited })
        }
      } catch (err) {
        console.error('检查收藏状态失败', err)
      }
    },

    async toggle() {
      const action = this.data.isFavorited ? 'remove' : 'add'

      try {
        const res = await wx.cloud.callFunction({
          name: 'favorite',
          data: {
            action,
            menuItemId: this.data.menuItemId
          }
        })

        if (res.result.success) {
          this.setData({
            isFavorited: !this.data.isFavorited
          })
          wx.showToast({
            title: this.data.isFavorited ? '收藏成功' : '已取消',
            icon: 'success'
          })

          // 触发事件
          this.triggerEvent('change', {
            isFavorited: this.data.isFavorited,
            menuItemId: this.data.menuItemId
          })
        } else {
          wx.showToast({ title: res.result.errMsg, icon: 'none' })
        }
      } catch (err) {
        wx.showToast({ title: '操作失败', icon: 'none' })
      }
    }
  }
})
```

---

## 5. 开发步骤

### Step 1: 创建数据库集合
```javascript
// 在云开发控制台创建
// favorites 集合
```

### Step 2: 创建 favorite 云函数
```bash
# 在 cloudfunctions 目录下创建 favorite 云函数
```

### Step 3: 编写云函数代码
- 复制上述 favorite 云函数代码
- 部署云函数

### Step 4: 创建收藏按钮组件
```bash
# 创建组件
miniprogram/components/favorite-btn/
```

### Step 5: 创建收藏列表页面
```bash
# 创建页面
miniprogram/pages/favorites/index/
```

### Step 6: 在菜品卡片中集成收藏按钮
- 在 menu/index 页面的菜品卡片中引入收藏按钮组件

### Step 7: 测试功能
- 测试收藏/取消收藏
- 测试收藏列表展示
- 测试从收藏夹添加

---

## 6. 注意事项

1. **防止重复收藏**：数据库有唯一索引双重保护
2. **收藏夹与菜单同步**：菜品下架后，收藏列表中对应菜品显示特殊标记
3. **性能优化**：批量检查收藏状态使用云函数查询
4. **用户体验**：收藏成功/取消要有明确提示

---

## 7. 测试用例

| 用例 | 预期结果 |
|------|----------|
| 点击收藏按钮 | 收藏成功，图标变化 |
| 再次点击取消收藏 | 取消成功，图标变化 |
| 收藏已下架菜品 | 收藏成功但显示异常标记 |
| 进入收藏列表 | 显示所有收藏的菜品 |
| 从收藏夹点击点餐 | 跳转到点餐页面 |

---

## 8. 后续优化

- [ ] 收藏夹分组/标签
- [ ] 收藏夹排序（按添加时间/价格/评分）
- [ ] 收藏夹搜索
- [ ] 收藏夹分享
- [ ] 猜你喜欢推荐
