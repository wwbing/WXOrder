# 菜单管理模块设计文档

> 模块编号：02
> 优先级：P0（第一阶段）
> 预估工作量：1.5天

---

## 1. 模块概述

### 1.1 功能范围
- 菜单分类管理（增删改查、排序）
- 菜品管理（增删改查、上架/下架）
- 菜品图片上传
- 今日推荐设置

### 1.2 模块依赖
- 用户与家庭模块（需要 family_id）

---

## 2. 数据库设计

### 2.1 menu_categories（菜单分类表）

```javascript
// 云开发数据库集合名称：menu_categories

{
  "_id": "ObjectId",
  "family_id": "家庭ID",
  "name": "主食",                    // 分类名称
  "icon": "图标URL",                 // 分类图标（可选）
  "color": "#07C160",               // 标签颜色
  "sort_order": 0,                  // 排序权重（越小越靠前）
  "is_active": true,                // 是否启用
  "created_by": "创建者openid",
  "created_at": "Date",
  "updated_at": "Date"
}

// 索引设计
db.menu_categories.createIndex({ "family_id": 1, "sort_order": 1 })
db.menu_categories.createIndex({ "family_id": 1, "is_active": 1 })
```

### 2.2 menu_items（菜品表）

```javascript
// 云开发数据库集合名称：menu_items

{
  "_id": "ObjectId",
  "family_id": "家庭ID",
  "category_id": "分类ID",
  "name": "红烧肉",                  // 菜品名称
  "price": 3500,                    // 价格（单位：分）
  "image_url": "云存储ID",           // 主图
  "images": ["云存储ID1", "云存储ID2"], // 附加图片（可选）
  "description": "肥而不腻，入口即化",   // 菜品描述
  "is_available": true,             // 是否上架
  "is_recommended": false,          // 今日推荐
  "sort_order": 0,                  // 排序权重
  "created_by": "创建者openid",
  "created_at": "Date",
  "updated_at": "Date"
}

// 索引设计
db.menu_items.createIndex({ "family_id": 1, "category_id": 1, "sort_order": 1 })
db.menu_items.createIndex({ "family_id": 1, "is_available": 1 })
db.menu_items.createIndex({ "family_id": 1, "is_recommended": 1 })
db.menu_items.createIndex({ "name": "text" }) // 全文索引，支持搜索
```

---

## 3. 云函数设计

### 3.1 menu 云函数

**文件路径**：`cloudfunctions/menu/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()
const _ = db.command

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action, data } = event

  // 验证用户是否属于该家庭
  async function validateUserFamily(familyId) {
    const userRes = await db.collection('users').where({
      openid: wxContext.OPENID,
      family_id: familyId
    }).get()

    if (userRes.data.length === 0) {
      throw new Error('您不属于该家庭')
    }
    return userRes.data[0]
  }

  try {
    switch (action) {
      // ========== 分类相关 ==========

      case 'getCategories':
        // 获取分类列表
        const { familyId } = data
        await validateUserFamily(familyId)

        const categoriesRes = await db.collection('menu_categories')
          .where({
            family_id: familyId,
            is_active: true
          })
          .orderBy('sort_order', 'asc')
          .get()

        return { success: true, data: categoriesRes.data }

      case 'createCategory':
        // 创建分类
        const { familyId, name, color, icon } = data
        await validateUserFamily(familyId)

        const maxSortRes = await db.collection('menu_categories')
          .where({ family_id: familyId })
          .orderBy('sort_order', 'desc')
          .limit(1)
          .get()

        const maxSort = maxSortRes.data.length > 0 ? maxSortRes.data[0].sort_order : 0

        const categoryRes = await db.collection('menu_categories').add({
          data: {
            family_id: familyId,
            name: name,
            icon: icon || '',
            color: color || '#07C160',
            sort_order: maxSort + 1,
            is_active: true,
            created_by: wxContext.OPENID,
            created_at: new Date(),
            updated_at: new Date()
          }
        })

        return { success: true, data: { _id: categoryRes._id } }

      case 'updateCategory':
        // 更新分类
        const { categoryId, name, color, icon, sortOrder } = data
        const category = await db.collection('menu_categories').doc(categoryId).get()
        await validateUserFamily(category.data.family_id)

        const updateData = { updated_at: new Date() }
        if (name !== undefined) updateData.name = name
        if (color !== undefined) updateData.color = color
        if (icon !== undefined) updateData.icon = icon
        if (sortOrder !== undefined) updateData.sort_order = sortOrder

        await db.collection('menu_categories').doc(categoryId).update({
          data: updateData
        })

        return { success: true }

      case 'deleteCategory':
        // 删除分类
        const { categoryId: delCategoryId } = data
        const delCategory = await db.collection('menu_categories').doc(delCategoryId).get()
        await validateUserFamily(delCategory.data.family_id)

        // 检查分类下是否有菜品
        const itemsCount = await db.collection('menu_items')
          .where({
            category_id: delCategoryId,
            is_available: true
          })
          .count()

        if (itemsCount.total > 0) {
          throw new Error('该分类下有菜品，无法删除')
        }

        await db.collection('menu_categories').doc(delCategoryId).update({
          data: { is_active: false }
        })

        return { success: true }

      // ========== 菜品相关 ==========

      case 'getItems':
        // 获取菜品列表
        const { familyId: itemFamilyId, categoryId, keyword } = data
        await validateUserFamily(itemFamilyId)

        let query = db.collection('menu_items').where({
          family_id: itemFamilyId,
          is_available: true
        })

        if (categoryId) {
          query = query.where({ category_id: categoryId })
        }

        if (keyword) {
          query = query.where({
            name: db.RegExp({
              regexp: keyword,
              options: 'i'
            })
          })
        }

        const itemsRes = await query
          .orderBy('category_id', 'asc')
          .orderBy('sort_order', 'asc')
          .get()

        return { success: true, data: itemsRes.data }

      case 'getItemDetail':
        // 获取菜品详情
        const { itemId } = data
        const item = await db.collection('menu_items').doc(itemId).get()

        if (!item.data) {
          throw new Error('菜品不存在')
        }

        await validateUserFamily(item.data.family_id)

        return { success: true, data: item.data }

      case 'createItem':
        // 创建菜品
        const itemData = data
        await validateUserFamily(itemData.familyId)

        const maxItemSortRes = await db.collection('menu_items')
          .where({
            family_id: itemData.familyId,
            category_id: itemData.categoryId
          })
          .orderBy('sort_order', 'desc')
          .limit(1)
          .get()

        const maxItemSort = maxItemSortRes.data.length > 0
          ? maxItemSortRes.data[0].sort_order
          : 0

        const newItemRes = await db.collection('menu_items').add({
          data: {
            family_id: itemData.familyId,
            category_id: itemData.categoryId,
            name: itemData.name,
            price: Math.round(itemData.price * 100), // 转为分
            image_url: itemData.imageUrl || '',
            images: itemData.images || [],
            description: itemData.description || '',
            is_available: true,
            is_recommended: false,
            sort_order: maxItemSort + 1,
            created_by: wxContext.OPENID,
            created_at: new Date(),
            updated_at: new Date()
          }
        })

        return { success: true, data: { _id: newItemRes._id } }

      case 'updateItem':
        // 更新菜品
        const { itemId: updateItemId, ...updateFields } = data
        const updateItem = await db.collection('menu_items').doc(updateItemId).get()
        await validateUserFamily(updateItem.data.family_id)

        const dataToUpdate = { updated_at: new Date() }

        if (updateFields.name !== undefined) dataToUpdate.name = updateFields.name
        if (updateFields.price !== undefined) dataToUpdate.price = Math.round(updateFields.price * 100)
        if (updateFields.imageUrl !== undefined) dataToUpdate.image_url = updateFields.imageUrl
        if (updateFields.description !== undefined) dataToUpdate.description = updateFields.description
        if (updateFields.isAvailable !== undefined) dataToUpdate.is_available = updateFields.isAvailable
        if (updateFields.isRecommended !== undefined) dataToUpdate.is_recommended = updateFields.isRecommended
        if (updateFields.sortOrder !== undefined) dataToUpdate.sort_order = updateFields.sortOrder

        await db.collection('menu_items').doc(updateItemId).update({
          data: dataToUpdate
        })

        return { success: true }

      case 'deleteItem':
        // 删除菜品（软删除）
        const { itemId: delItemId } = data
        const delItem = await db.collection('menu_items').doc(delItemId).get()
        await validateUserFamily(delItem.data.family_id)

        await db.collection('menu_items').doc(delItemId).update({
          data: {
            is_available: false,
            updated_at: new Date()
          }
        })

        return { success: true }

      case 'toggleRecommend':
        // 切换推荐状态
        const { itemId: recommendItemId, isRecommended } = data
        const recommendItem = await db.collection('menu_items').doc(recommendItemId).get()
        await validateUserFamily(recommendItem.data.family_id)

        // 清除同分类的其他推荐
        if (isRecommended) {
          await db.collection('menu_items').where({
            family_id: recommendItem.data.family_id,
            category_id: recommendItem.data.category_id,
            is_recommended: true
          }).update({
            data: {
              is_recommended: false,
              updated_at: new Date()
            }
          })
        }

        await db.collection('menu_items').doc(recommendItemId).update({
          data: {
            is_recommended: isRecommended,
            updated_at: new Date()
          }
        })

        return { success: true }

      case 'batchUpdate':
        // 批量操作
        const { familyId: batchFamilyId, itemIds, action: batchAction } = data
        await validateUserFamily(batchFamilyId)

        const batchData = { updated_at: new Date() }

        switch (batchAction) {
          case 'batch_online':
            batchData.is_available = true
            break
          case 'batch_offline':
            batchData.is_available = false
            break
          case 'batch_delete':
            batchData.is_available = false
            break
        }

        await db.collection('menu_items').where({
          _id: db.command.in(itemIds),
          family_id: batchFamilyId
        }).update({
          data: batchData
        })

        return { success: true }

      case 'getRecommended':
        // 获取今日推荐
        const { familyId: recFamilyId } = data
        await validateUserFamily(recFamilyId)

        const recommendedRes = await db.collection('menu_items')
          .where({
            family_id: recFamilyId,
            is_recommended: true,
            is_available: true
          })
          .limit(10)
          .get()

        return { success: true, data: recommendedRes.data }
    }
  } catch (err) {
    return { success: false, errMsg: err.message }
  }
}
```

---

## 4. 页面设计

### 4.1 页面结构

```
pages/
├── menu/
│   ├── index/              # 菜单浏览页
│   └── detail/             # 菜品详情页
└── admin/
    ├── menu-manage/        # 菜品管理页
    │   ├── list/           # 菜品列表
    │   └── editor/         # 菜品编辑器
    └── category-manage/    # 分类管理页
```

### 4.2 menu/index 页面（菜单浏览页）

**文件**：`pages/menu/index/index`

#### 功能说明
- 显示分类Tab
- 按分类展示菜品
- 支持搜索
- 菜品卡片显示：图片、名称、价格、推荐标签

#### WXML 结构
```xml
<view class="container">
  <!-- 搜索栏 -->
  <view class="search-bar">
    <input class="search-input" placeholder="搜索菜品" bindinput="onSearch" />
    <image class="search-icon" src="/miniprogram/images/icons/search.png" />
  </view>

  <!-- 分类Tab -->
  <scroll-view scroll-x class="category-scroll" wx:if="{{categories.length > 0}}">
    <view class="category-list">
      <view
        class="category-item {{activeCategoryId === item._id ? 'active' : ''}}"
        wx:for="{{categories}}"
        wx:key="_id"
        data-id="{{item._id}}"
        bindtap="onCategoryTap"
        style="border-left-color: {{item.color}}"
      >
        {{item.name}}
      </view>
    </view>
  </scroll-view>

  <!-- 菜品列表 -->
  <scroll-view scroll-y class="menu-scroll">
    <view class="menu-list" wx:if="{{items.length > 0}}">
      <view class="menu-item" wx:for="{{items}}" wx:key="_id" bindtap="goToDetail" data-id="{{item._id}}">
        <image class="item-image" src="{{item.image_url || '/miniprogram/images/default-goods-image.png'}}" mode="aspectFill" />
        <view class="item-info">
          <view class="item-header">
            <text class="item-name">{{item.name}}</text>
            <text class="item-price">¥{{item.price / 100}}</text>
          </view>
          <text class="item-desc">{{item.description || '暂无描述'}}</text>
          <view class="item-tags" wx:if="{{item.is_recommended}}">
            <text class="tag recommended">推荐</text>
          </view>
        </view>
        <view class="add-btn" catchtap="addToCart" data-item="{{item}}">+</view>
      </view>
    </view>

    <view class="empty-state" wx:elif="{{!loading}}">
      <text>暂无菜品</text>
    </view>
  </scroll-view>
</view>
```

---

## 5. 开发步骤

### Step 1: 创建数据库集合
```javascript
// 在云开发控制台创建以下集合
// 1. menu_categories
// 2. menu_items
```

### Step 2: 创建 menu 云函数
```bash
# 在 cloudfunctions 目录下创建 menu 云函数
```

### Step 3: 编写云函数代码
- 复制上述 menu 云函数代码
- 部署云函数

### Step 4: 创建页面文件
```bash
# 创建页面结构
miniprogram/pages/menu/index/
miniprogram/pages/menu/detail/
miniprogram/pages/admin/menu-manage/
miniprogram/pages/admin/category-manage/
```

### Step 5: 添加初始数据
- 在云开发控制台添加默认分类（主食、小菜、饮料等）

### Step 6: 测试功能
- 测试分类的增删改查
- 测试菜品的增删改查
- 测试图片上传

---

## 6. 图片上传工具函数

```javascript
// utils/upload.js

/**
 * 上传图片到云存储
 * @param {string} filePath 图片本地路径
 * @param {string} dir 上传目录
 * @returns {Promise<string>} 云存储文件ID
 */
function uploadImage(filePath, dir = 'menu') {
  const cloudPath = `${dir}/${Date.now()}-${Math.random()}.${filePath.split('.').pop()}`

  return new Promise((resolve, reject) => {
    wx.cloud.uploadFile({
      cloudPath,
      filePath,
      success: res => {
        resolve(res.fileID)
      },
      fail: err => {
        reject(err)
      }
    })
  })
}

/**
 * 选择并上传图片
 * @param {number} count 最大选择数量
 * @param {string} dir 上传目录
 * @returns {Promise<string[]>} 云存储文件ID数组
 */
async function chooseAndUpload(count = 1, dir = 'menu') {
  return new Promise((resolve, reject) => {
    wx.chooseMedia({
      count,
      mediaType: ['image'],
      sourceType: ['album', 'camera'],
      success: async (res) => {
        try {
          const fileIDs = await Promise.all(
            res.tempFiles.map(item => uploadImage(item.tempFilePath, dir))
          )
          resolve(fileIDs)
        } catch (err) {
          reject(err)
        }
      },
      fail: reject
    })
  })
}

module.exports = {
  uploadImage,
  chooseAndUpload
}
```

---

## 7. 注意事项

1. **价格存储**：价格统一以"分"为单位存储，避免浮点数精度问题
2. **图片大小**：建议限制图片大小（如最大2MB），可使用 `wx.compressImage`
3. **分类删除**：删除分类前检查是否有菜品，避免数据不一致
4. **权限控制**：只有家庭成员可以操作菜单数据
5. **搜索性能**：大规模数据建议使用云函数搜索，前端分页

---

## 8. 测试用例

| 用例 | 预期结果 |
|------|----------|
| 创建分类 | 分类列表显示新分类 |
| 删除空分类 | 删除成功 |
| 删除有菜品的分类 | 提示无法删除 |
| 创建菜品 | 菜品显示在对应分类下 |
| 设置推荐 | 菜品显示推荐标签 |
| 搜索菜品 | 显示匹配的菜品 |
| 下架菜品 | 菜品不在菜单中显示 |

---

## 9. 后续优化

- [ ] 菜品批量导入
- [ ] 菜品复制功能
- [ ] 口味/规格设置
- [ ] 套餐功能
- [ ] 菜品销量统计
