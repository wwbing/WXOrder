# 评价功能模块设计文档

> 模块编号：04
> 优先级：P1（第二阶段）
> 预估工作量：1.5天

---

## 1. 模块概述

### 1.1 功能范围
- 菜品评分（1-5星）
- 评价文字
- 评价图片（最多3张）
- 口味标签选择
- 评价列表展示
- 评价统计（平均分、评分分布）

### 1.2 模块依赖
- 用户与家庭模块
- 菜单管理模块
- 订单管理模块

---

## 2. 数据库设计

### 2.1 reviews（评价表）

```javascript
// 云开发数据库集合名称：reviews

{
  "_id": "ObjectId",
  "menu_item_id": "菜品ID",
  "order_id": "订单ID（可选）",       // 关联订单，便于追溯
  "user_openid": "用户openid",
  "user_name": "用户昵称（冗余）",
  "user_avatar": "用户头像URL（冗余）",
  "rating": 5,                       // 评分 1-5
  "content": "味道很棒！",            // 评价内容
  "images": ["图片URL1", "图片URL2"], // 评价图片
  "taste_tags": ["好吃", "份量足"],   // 口味标签
  "is_anonymous": false,             // 是否匿名
  "is_verified": true,               // 是否为真实订单评价
  "created_at": "Date",
  "updated_at": "Date"
}

// 索引设计
db.reviews.createIndex({ "menu_item_id": 1, "created_at": -1 })
db.reviews.createIndex({ "user_openid": 1, "created_at": -1 })
db.reviews.createIndex({ "order_id": 1 })
db.reviews.createIndex({ "menu_item_id": 1, "rating": 1 })
```

### 2.2 review_stats（评价统计表 - 用于缓存）

```javascript
// 云开发数据库集合名称：review_stats

{
  "_id": "ObjectId",                 // 使用 menu_item_id 作为 _id
  "menu_item_id": "菜品ID",
  "avg_rating": 4.5,                 // 平均分
  "total_count": 100,                // 评价总数
  "rating_distribution": {           // 评分分布
    "1": 2,
    "2": 5,
    "3": 10,
    "4": 30,
    "5": 53
  },
  "popular_tags": [                  // 热门标签
    { "tag": "好吃", "count": 50 },
    { "tag": "份量足", "count": 30 }
  ],
  "updated_at": "Date"
}

// 索引设计
db.review_stats.createIndex({ "menu_item_id": 1 }, { unique: true })
```

---

## 3. 云函数设计

### 3.1 review 云函数

**文件路径**：`cloudfunctions/review/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()
const _ = db.command

// 预设口味标签
const TASTE_TAGS = ['好吃', '一般', '偏咸', '偏淡', '份量足', '份量少', '味道正宗', '不推荐', '性价比高', '颜值高']

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action, data } = event

  // 验证用户
  async function getUser() {
    const userRes = await db.collection('users').where({
      openid: wxContext.OPENID
    }).get()

    if (userRes.data.length === 0) {
      throw new Error('用户不存在')
    }
    return userRes.data[0]
  }

  try {
    switch (action) {
      case 'create':
        // 发布评价
        const user = await getUser()

        const {
          menuItemId,
          orderId,
          rating,
          content,
          images,
          tasteTags,
          isAnonymous
        } = data

        // 验证菜品
        const itemRes = await db.collection('menu_items').doc(menuItemId).get()
        if (!itemRes.data) {
          throw new Error('菜品不存在')
        }

        // 检查是否已评价
        const existingRes = await db.collection('reviews').where({
          user_openid: wxContext.OPENID,
          menu_item_id: menuItemId,
          order_id: orderId || _.exists(false)
        }).get()

        if (existingRes.data.length > 0) {
          throw new Error('您已评价过该菜品')
        }

        // 创建评价
        const reviewRes = await db.collection('reviews').add({
          data: {
            menu_item_id: menuItemId,
            order_id: orderId || '',
            user_openid: wxContext.OPENID,
            user_name: isAnonymous ? '匿名用户' : user.nickname,
            user_avatar: isAnonymous ? '' : user.avatar_url,
            rating: rating,
            content: content || '',
            images: images || [],
            taste_tags: tasteTags || [],
            is_anonymous: isAnonymous || false,
            is_verified: !!orderId,
            created_at: new Date(),
            updated_at: new Date()
          }
        })

        // 更新统计
        await updateReviewStats(menuItemId)

        return { success: true, data: { reviewId: reviewRes._id } }

      case 'list':
        // 获取评价列表
        const { menuItemId, page = 1, pageSize = 10 } = data

        const reviewsRes = await db.collection('reviews')
          .where({
            menu_item_id: menuItemId
          })
          .orderBy('created_at', 'desc')
          .skip((page - 1) * pageSize)
          .limit(pageSize)
          .get()

        // 获取总数
        const totalRes = await db.collection('reviews')
          .where({ menu_item_id: menuItemId })
          .count()

        return {
          success: true,
          data: {
            list: reviewsRes.data,
            total: totalRes.total,
            tasteTags: TASTE_TAGS
          }
        }

      case 'myReviews':
        // 获取我的评价
        const { familyId, page = 1, pageSize = 10 } = data

        const myReviewsRes = await db.collection('reviews')
          .where({
            user_openid: wxContext.OPENID
          })
          .orderBy('created_at', 'desc')
          .skip((page - 1) * pageSize)
          .limit(pageSize)
          .get()

        // 获取菜品信息
        const itemIds = myReviewsRes.data.map(r => r.menu_item_id)
        const itemsRes = await db.collection('menu_items')
          .where({
            _id: _.in(itemIds)
          })
          .get()

        const itemMap = {}
        itemsRes.data.forEach(item => {
          itemMap[item._id] = item
        })

        const listWithItems = myReviewsRes.data.map(review => ({
          ...review,
          menu_item: itemMap[review.menu_item_id] || null
        }))

        const myTotalRes = await db.collection('reviews')
          .where({ user_openid: wxContext.OPENID })
          .count()

        return {
          success: true,
          data: {
            list: listWithItems,
            total: myTotalRes.total
          }
        }

      case 'getStats':
        // 获取评价统计
        const { menuItemId: statsItemId } = data

        // 先查缓存
        let statsRes = await db.collection('review_stats')
          .doc(statsItemId)
          .get()

        if (statsRes.data) {
          return { success: true, data: statsRes.data }
        }

        // 计算统计数据
        const reviews = await db.collection('reviews')
          .where({ menu_item_id: statsItemId })
          .get()

        if (reviews.data.length === 0) {
          return {
            success: true,
            data: {
              menu_item_id: statsItemId,
              avg_rating: 0,
              total_count: 0,
              rating_distribution: { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 },
              popular_tags: []
            }
          }
        }

        // 计算平均分
        const totalRating = reviews.data.reduce((sum, r) => sum + r.rating, 0)
        const avgRating = (totalRating / reviews.data.length).toFixed(1)

        // 计算评分分布
        const ratingDist = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 }
        reviews.data.forEach(r => {
          ratingDist[r.rating]++
        })

        // 计算热门标签
        const tagCount = {}
        reviews.data.forEach(r => {
          (r.taste_tags || []).forEach(tag => {
            tagCount[tag] = (tagCount[tag] || 0) + 1
          })
        })
        const popularTags = Object.entries(tagCount)
          .map(([tag, count]) => ({ tag, count }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 5)

        // 保存到缓存
        await db.collection('review_stats').doc(statsItemId).set({
          data: {
            menu_item_id: statsItemId,
            avg_rating: parseFloat(avgRating),
            total_count: reviews.data.length,
            rating_distribution: ratingDist,
            popular_tags: popularTags,
            updated_at: new Date()
          }
        })

        return {
          success: true,
          data: {
            menu_item_id: statsItemId,
            avg_rating: parseFloat(avgRating),
            total_count: reviews.data.length,
            rating_distribution: ratingDist,
            popular_tags: popularTags
          }
        }

      case 'delete':
        // 删除评价
        const { reviewId } = data

        const review = await db.collection('reviews').doc(reviewId).get()

        if (!review.data) {
          throw new Error('评价不存在')
        }

        if (review.data.user_openid !== wxContext.OPENID) {
          throw new Error('只能删除自己的评价')
        }

        await db.collection('reviews').doc(reviewId).remove()

        // 更新统计
        await updateReviewStats(review.data.menu_item_id)

        return { success: true }

      case 'canReview':
        // 检查是否可以评价订单中的菜品
        const { orderId: canReviewOrderId } = data

        const orderRes = await db.collection('orders').doc(canReviewOrderId).get()
        if (!orderRes.data) {
          return { success: true, data: { canReview: false, reason: '订单不存在' } }
        }

        if (orderRes.data.created_by !== wxContext.OPENID) {
          return { success: true, data: { canReview: false, reason: '只能评价自己的订单' } }
        }

        // 获取已评价的菜品
        const myReviews = await db.collection('reviews')
          .where({
            user_openid: wxContext.OPENID,
            order_id: canReviewOrderId
          })
          .get()

        const reviewedItemIds = myReviews.data.map(r => r.menu_item_id)

        // 获取订单中的菜品
        const selections = await db.collection('order_selections')
          .where({
            session_id: orderRes.data.session_id,
            user_openid: wxContext.OPENID
          })
          .get()

        if (selections.data.length === 0) {
          return { success: true, data: { canReview: false, reason: '订单中没有菜品' } }
        }

        const orderItemIds = selections.data[0].items.map(i => i.menu_item_id)
        const unreviewedItems = orderItemIds.filter(id => !reviewedItemIds.includes(id))

        return {
          success: true,
          data: {
            canReview: unreviewedItems.length > 0,
            unreviewedItemIds: unreviewedItems
          }
        }
    }
  } catch (err) {
    return { success: false, errMsg: err.message }
  }
}

// 更新评价统计
async function updateReviewStats(menuItemId) {
  try {
    const reviews = await db.collection('reviews')
      .where({ menu_item_id: menuItemId })
      .get()

    if (reviews.data.length === 0) {
      await db.collection('review_stats').doc(menuItemId).remove()
      return
    }

    // 计算
    const totalRating = reviews.data.reduce((sum, r) => sum + r.rating, 0)
    const avgRating = (totalRating / reviews.data.length).toFixed(1)

    const ratingDist = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 }
    reviews.data.forEach(r => {
      ratingDist[r.rating]++
    })

    const tagCount = {}
    reviews.data.forEach(r => {
      (r.taste_tags || []).forEach(tag => {
        tagCount[tag] = (tagCount[tag] || 0) + 1
      })
    })
    const popularTags = Object.entries(tagCount)
      .map(([tag, count]) => ({ tag, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5)

    // 保存
    await db.collection('review_stats').doc(menuItemId).set({
      data: {
        menu_item_id: menuItemId,
        avg_rating: parseFloat(avgRating),
        total_count: reviews.data.length,
        rating_distribution: ratingDist,
        popular_tags: popularTags,
        updated_at: new Date()
      }
    })
  } catch (err) {
    console.error('更新评价统计失败', err)
  }
}
```

---

## 4. 页面设计

### 4.1 页面结构

```
pages/
├── review/
│   ├── create/            # 发起评价页
│   └── list/              # 评价列表页
└── menu/
    └── detail/            # 菜品详情页（增加评价入口）
```

### 4.2 review/create 页面（发起评价）

**文件**：`pages/review/create/index`

#### 功能说明
- 选择评分（星级）
- 输入评价文字
- 上传评价图片
- 选择口味标签

#### WXML 结构
```xml
<view class="container">
  <!-- 菜品信息 -->
  <view class="menu-item-info">
    <image class="item-image" src="{{menuItem.image_url || '/miniprogram/images/default-goods-image.png'}}" />
    <view class="item-detail">
      <text class="item-name">{{menuItem.name}}</text>
      <text class="item-price">¥{{menuItem.price / 100}}</text>
    </view>
  </view>

  <!-- 评分 -->
  <view class="rating-section">
    <text class="section-title">为这道菜打分</text>
    <view class="stars">
      <view
        class="star {{rating >= item ? 'active' : ''}}"
        wx:for="{{[1,2,3,4,5]}}"
        wx:key="*this"
        data-rating="{{item}}"
        bindtap="onRatingTap"
      >
        ★
      </view>
    </view>
    <text class="rating-text">{{ratingText}}</text>
  </view>

  <!-- 口味标签 -->
  <view class="tags-section">
    <text class="section-title">选择口味标签（可选）</text>
    <view class="tags-list">
      <view
        class="tag {{selectedTags.includes(item) ? 'active' : ''}}"
        wx:for="{{tasteTags}}"
        wx:key="*this"
        data-tag="{{item}}"
        bindtap="onTagTap"
      >
        {{item}}
      </view>
    </view>
  </view>

  <!-- 评价内容 -->
  <view class="content-section">
    <text class="section-title">分享您的用餐体验（可选）</text>
    <textarea
      class="content-input"
      placeholder="这道菜味道如何？有什么想说的..."
      bindinput="onContentInput"
      maxlength="500"
    />
    <text class="char-count">{{content.length}}/500</text>
  </view>

  <!-- 评价图片 -->
  <view class="images-section">
    <text class="section-title">上传图片（最多3张）</text>
    <view class="images-list">
      <view class="image-item" wx:for="{{images}}" wx:key="*this">
        <image class="uploaded-image" src="{{item}}" mode="aspectFill" />
        <view class="delete-btn" catchtap="deleteImage" data-index="{{index}}">×</view>
      </view>
      <view class="add-image" bindtap="addImage" wx:if="{{images.length < 3}}">
        <text class="plus">+</text>
        <text class="text">添加图片</text>
      </view>
    </view>
  </view>

  <!-- 匿名选项 -->
  <view class="anonymous-section">
    <checkbox-group bindchange="onAnonymousChange">
      <checkbox value="anonymous" checked="{{isAnonymous}}" />
    </checkbox-group>
    <text bindtap="onAnonymousChange">匿名评价</text>
  </view>

  <!-- 提交按钮 -->
  <button class="submit-btn" bindtap="submitReview" disabled="{{!rating}}">提交评价</button>
</view>
```

### 4.3 review/list 页面（评价列表）

**文件**：`pages/review/list/index`

#### 功能说明
- 显示评价统计（平均分、评分分布）
- 展示评价列表
- 支持按标签筛选

#### WXML 结构
```xml
<view class="container">
  <!-- 评价统计 -->
  <view class="stats-card" wx:if="{{stats}}">
    <view class="avg-rating">
      <text class="score">{{stats.avg_rating}}</text>
      <text class="unit">分</text>
    </view>
    <view class="rating-info">
      <view class="stars">
        <view class="star active" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">
          {{item <= stats.avg_rating ? '★' : '☆'}}
        </view>
      </view>
      <text class="total">{{stats.total_count}} 条评价</text>
    </view>

    <!-- 评分分布 -->
    <view class="rating-bars" wx:if="{{stats.rating_distribution}}">
      <view class="bar-row" wx:for="{{[5,4,3,2,1]}}" wx:key="*this" wx:for-index="idx">
        <text class="star-num">{{item}}星</text>
        <view class="bar-bg">
          <view class="bar-fill" style="width: {{getBarWidth(item)}}%"></view>
        </view>
        <text class="bar-count">{{stats.rating_distribution[item] || 0}}</text>
      </view>
    </view>

    <!-- 热门标签 -->
    <view class="popular-tags" wx:if="{{stats.popular_tags && stats.popular_tags.length > 0}}">
      <text class="tags-title">大家都在说</text>
      <view class="tags-list">
        <text class="tag" wx:for="{{stats.popular_tags}}" wx:key="tag">{{item.tag}} ({{item.count}})</text>
      </view>
    </view>
  </view>

  <!-- 评价列表 -->
  <view class="reviews-list" wx:if="{{list.length > 0}}">
    <view class="review-item" wx:for="{{list}}" wx:key="_id">
      <view class="review-header">
        <image class="user-avatar" src="{{item.user_avatar || '/miniprogram/images/avatar.png'}}" />
        <view class="user-info">
          <text class="user-name">{{item.user_name}}</text>
          <view class="review-rating">
            <text class="star" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">{{item.rating >= item ? '★' : '☆'}}</text>
          </view>
        </view>
        <text class="review-time">{{formatTime(item.created_at)}}</text>
      </view>

      <view class="review-content" wx:if="{{item.content}}">
        {{item.content}}
      </view>

      <!-- 评价图片 -->
      <view class="review-images" wx:if="{{item.images && item.images.length > 0}}">
        <image
          class="review-image"
          wx:for="{{item.images}}"
          wx:for-item="img"
          wx:key="*this"
          src="{{img}}"
          mode="aspectFill"
          catchtap="previewImage"
          data-urls="{{item.images}}"
          data-current="{{img}}"
        />
      </view>

      <!-- 口味标签 -->
      <view class="review-tags" wx:if="{{item.taste_tags && item.taste_tags.length > 0}}">
        <text class="tag" wx:for="{{item.taste_tags}}" wx:key="*this">{{item}}</text>
      </view>
    </view>
  </view>

  <view class="empty-state" wx:if="{{list.length === 0 && !loading}}">
    <text>暂无评价</text>
  </view>
</view>
```

---

## 5. 开发步骤

### Step 1: 创建数据库集合
```javascript
// 在云开发控制台创建
// 1. reviews
// 2. review_stats
```

### Step 2: 创建 review 云函数
```bash
# 在 cloudfunctions 目录下创建 review 云函数
```

### Step 3: 编写云函数代码
- 复制上述 review 云函数代码
- 部署云函数

### Step 4: 创建页面文件
```bash
# 创建页面
miniprogram/pages/review/create/
miniprogram/pages/review/list/
```

### Step 5: 在菜品详情页添加评价入口
- 在 menu/detail 页面添加评价统计展示
- 添加跳转评价列表的入口

### Step 6: 测试功能
- 测试发布评价
- 测试评价列表
- 测试评价统计

---

## 6. 图片上传工具函数

```javascript
// utils/upload.js 新增

/**
 * 上传评价图片
 * @param {string} tempFilePath 图片临时路径
 * @returns {Promise<string>} 云存储文件ID
 */
async function uploadReviewImage(tempFilePath) {
  const cloudPath = `reviews/${Date.now()}-${Math.random()}.${tempFilePath.split('.').pop()}`

  return new Promise((resolve, reject) => {
    wx.cloud.uploadFile({
      cloudPath,
      filePath: tempFilePath,
      success: res => resolve(res.fileID),
      fail: reject
    })
  })
}

/**
 * 选择并压缩评价图片
 * @param {number} count 数量
 * @returns {Promise<string[]>} 云存储文件ID数组
 */
async function chooseReviewImages(count = 3) {
  return new Promise((resolve, reject) => {
    wx.chooseMedia({
      count,
      mediaType: ['image'],
      sourceType: ['album', 'camera'],
      success: async (res) => {
        try {
          // 压缩图片
          const fileIDs = await Promise.all(
            res.tempFiles.map(async (item) => {
              // 压缩
              const compressRes = await new Promise((resolve, reject) => {
                wx.compressImage({
                  src: item.tempFilePath,
                  quality: 80,
                  success: resolve,
                  fail: reject
                })
              })

              // 上传
              return await uploadReviewImage(compressRes.tempFilePath)
            })
          )
          resolve(fileIDs)
        } catch (err) {
          reject(err)
        }
      },
      fail: reject
    })
  })
}
```

---

## 7. 注意事项

1. **评价次数限制**：同一订单同一菜品只能评价一次
2. **图片大小限制**：评价图片建议压缩后上传
3. **统计更新**：评价提交/删除后需要更新统计缓存
4. **图片删除**：用户可以删除自己上传的评价图片
5. **隐私保护**：匿名评价不显示用户头像和昵称

---

## 8. 测试用例

| 用例 | 预期结果 |
|------|----------|
| 选择星级评分 | 显示对应星级 |
| 提交无评分评价 | 提示需要评分 |
| 上传4张图片 | 提示最多3张 |
| 重复评价同一菜品 | 提示已评价 |
| 删除自己的评价 | 删除成功，统计更新 |
| 查看评价统计 | 显示平均分和分布 |

---

## 9. 后续优化

- [ ] 评价回复功能（商家回复）
- [ ] 评价分享
- [ ] 评价打赏/点赞
- [ ] 优质评价展示
- [ ] AI评价摘要
