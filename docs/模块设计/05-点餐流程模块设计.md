# 点餐流程模块设计文档

> 模块编号：05
> 优先级：P0（第一阶段）
> 预估工作量：2天

---

## 1. 模块概述

### 1.1 功能范围
- 创建点餐会话
- 设置截止时间
- 分享点餐链接
- 成员选择菜品
- 实时查看他人选择
- 关闭会话/生成订单

### 1.2 模块依赖
- 用户与家庭模块
- 菜单管理模块
- 收藏功能模块（可选）

---

## 2. 数据库设计

### 2.1 dining_sessions（点餐会话表）

```javascript
// 云开发数据库集合名称：dining_sessions

{
  "_id": "ObjectId",
  "family_id": "家庭ID",
  "title": "午餐点餐",               // 点餐标题
  "created_by": "用户openid",        // 发起点餐的用户
  "status": "active",                // active/closed/cancelled
  "deadline": "Date",                // 截止时间
  "preset_items": ["菜品ID数组"],     // 预选菜品（可选）
  "total_amount": 0,                 // 汇总金额（分）
  "order_count": 0,                  // 参与人数
  "created_at": "Date",
  "closed_at": "Date"
}

// 索引设计
db.dining_sessions.createIndex({ "family_id": 1, "status": 1, "created_at": -1 })
db.dining_sessions.createIndex({ "created_by": 1 })
db.dining_sessions.createIndex({ "deadline": 1 })
```

### 2.2 order_selections（点餐选择表）

```javascript
// 云开发数据库集合名称：order_selections

{
  "_id": "ObjectId",
  "session_id": "会话ID",
  "user_openid": "用户openid",
  "user_name": "用户昵称（冗余）",
  "user_avatar": "头像URL（冗余）",
  "items": [
    {
      "menu_item_id": "菜品ID",
      "menu_item_name": "菜品名称（冗余）",
      "menu_item_price": 3500,       // 下单时的价格（分）
      "quantity": 2,                 // 份数
      "note": "不要香菜"              // 备注
    }
  ],
  "subtotal": 7000,                  // 小计金额（分）
  "created_at": "Date",
  "updated_at": "Date"
}

// 索引设计
db.order_selections.createIndex({ "session_id": 1, "user_openid": 1 }, { unique: true })
db.order_selections.createIndex({ "session_id": 1 })
```

---

## 3. 云函数设计

### 3.1 ordering 云函数

**文件路径**：`cloudfunctions/ordering/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()
const _ = db.command

// 截止时间选项（分钟）
const DEADLINE_OPTIONS = [15, 30, 45, 60, 90, 120]

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action, data } = event

  // 验证用户
  async function getUser() {
    const userRes = await db.collection('users').where({
      openid: wxContext.OPENID
    }).get()

    if (userRes.data.length === 0) {
      throw new Error('用户不存在')
    }
    return userRes.data[0]
  }

  // 验证会话
  async function getSession(sessionId) {
    const sessionRes = await db.collection('dining_sessions').doc(sessionId).get()
    if (!sessionRes.data) {
      throw new Error('会话不存在')
    }
    return sessionRes.data
  }

  try {
    switch (action) {
      case 'createSession':
        // 创建点餐会话
        const user = await getUser()
        const { title, deadlineMinutes, presetItems } = data

        // 检查是否有进行中的会话
        const existingSession = await db.collection('dining_sessions')
          .where({
            family_id: user.family_id,
            status: 'active'
          })
          .get()

        if (existingSession.data.length > 0) {
          throw new Error('当前已有进行中的点餐，请先完成或取消')
        }

        // 计算截止时间
        const deadline = new Date(Date.now() + (deadlineMinutes || 60) * 60 * 1000)

        // 创建会话
        const sessionRes = await db.collection('dining_sessions').add({
          data: {
            family_id: user.family_id,
            title: title || '点餐',
            created_by: wxContext.OPENID,
            status: 'active',
            deadline: deadline,
            preset_items: presetItems || [],
            total_amount: 0,
            order_count: 0,
            created_at: new Date(),
            closed_at: null
          }
        })

        return {
          success: true,
          data: {
            sessionId: sessionRes._id,
            deadline: deadline
          }
        }

      case 'getSession':
        // 获取会话详情
        const session = await getSession(data.sessionId)
        return { success: true, data: session }

      case 'getActiveSession':
        // 获取当前进行中的会话
        const { familyId } = data

        const activeRes = await db.collection('dining_sessions')
          .where({
            family_id: familyId,
            status: 'active'
          })
          .get()

        if (activeRes.data.length === 0) {
          return { success: true, data: null }
        }

        return { success: true, data: activeRes.data[0] }

      case 'getSessionList':
        // 获取会话列表
        const { familyId: listFamilyId, status, page = 1, pageSize = 10 } = data

        let query = db.collection('dining_sessions')
          .where({
            family_id: listFamilyId
          })

        if (status) {
          query = query.where({ status: status })
        }

        const sessionsRes = await query
          .orderBy('created_at', 'desc')
          .skip((page - 1) * pageSize)
          .limit(pageSize)
          .get()

        const totalRes = await db.collection('dining_sessions')
          .where({ family_id: listFamilyId })
          .count()

        return {
          success: true,
          data: {
            list: sessionsRes.data,
            total: totalRes.total
          }
        }

      case 'submitSelection':
        // 提交/更新选择
        const userSelection = await getUser()
        const { sessionId, items } = data

        // 验证会话
        const selectionSession = await getSession(sessionId)

        if (selectionSession.status !== 'active') {
          throw new Error('该点餐已结束')
        }

        if (new Date() > new Date(selectionSession.deadline)) {
          throw new Error('已超过截止时间')
        }

        // 计算小计
        let subtotal = 0
        const processedItems = await Promise.all(items.map(async (item) => {
          const menuItem = await db.collection('menu_items').doc(item.menu_item_id).get()
          if (!menuItem.data) {
            throw new Error(`菜品不存在: ${item.menu_item_id}`)
          }
          const price = menuItem.data.price
          subtotal += price * item.quantity
          return {
            menu_item_id: item.menu_item_id,
            menu_item_name: menuItem.data.name,
            menu_item_price: price,
            quantity: item.quantity,
            note: item.note || ''
          }
        }))

        // 检查是否已有选择
        const existingSelection = await db.collection('order_selections')
          .where({
            session_id: sessionId,
            user_openid: wxContext.OPENID
          })
          .get()

        if (existingSelection.data.length > 0) {
          // 更新
          await db.collection('order_selections').doc(existingSelection.data[0]._id).update({
            data: {
              items: processedItems,
              subtotal: subtotal,
              updated_at: new Date()
            }
          })
        } else {
          // 新增
          await db.collection('order_selections').add({
            data: {
              session_id: sessionId,
              user_openid: wxContext.OPENID,
              user_name: userSelection.nickname,
              user_avatar: userSelection.avatar_url,
              items: processedItems,
              subtotal: subtotal,
              created_at: new Date(),
              updated_at: new Date()
            }
          })

          // 更新会话参与人数
          await db.collection('dining_sessions').doc(sessionId).update({
            data: {
              order_count: _.inc(1),
              total_amount: _.inc(subtotal)
            }
          })
        }

        // 重新计算会话总金额
        const allSelections = await db.collection('order_selections')
          .where({ session_id: sessionId })
          .get()

        const totalAmount = allSelections.data.reduce((sum, s) => sum + s.subtotal, 0)

        await db.collection('dining_sessions').doc(sessionId).update({
          data: {
            total_amount: totalAmount
          }
        })

        return {
          success: true,
          data: {
            subtotal: subtotal,
            totalAmount: totalAmount
          }
        }

      case 'getSelections':
        // 获取所有选择（实时汇总）
        const { sessionId: selectionsSessionId } = data

        const selectionsRes = await db.collection('order_selections')
          .where({
            session_id: selectionsSessionId
          })
          .get()

        return {
          success: true,
          data: selectionsRes.data
        }

      case 'getMySelection':
        // 获取我的选择
        const { sessionId: mySessionId } = data

        const mySelectionRes = await db.collection('order_selections')
          .where({
            session_id: mySessionId,
            user_openid: wxContext.OPENID
          })
          .get()

        return {
          success: true,
          data: mySelectionRes.data[0] || null
        }

      case 'closeSession':
        // 关闭会话
        const { sessionId: closeSessionId } = data

        const closeSession = await getSession(closeSessionId)

        if (closeSession.created_by !== wxContext.OPENID) {
          throw new Error('只有发起点餐的用户可以关闭')
        }

        await db.collection('dining_sessions').doc(closeSessionId).update({
          data: {
            status: 'closed',
            closed_at: new Date()
          }
        })

        return { success: true }

      case 'cancelSession':
        // 取消点餐
        const { sessionId: cancelSessionId } = data

        const cancelSession = await getSession(cancelSessionId)

        if (cancelSession.created_by !== wxContext.OPENID) {
          throw new Error('只有发起点餐的用户可以取消')
        }

        await db.collection('dining_sessions').doc(cancelSessionId).update({
          data: {
            status: 'cancelled',
            closed_at: new Date()
          }
        })

        // 删除所有选择
        await db.collection('order_selections')
          .where({ session_id: cancelSessionId })
          .remove()

        return { success: true }

      case 'autoCloseExpired':
        // 自动关闭过期会话（定时任务调用）
        const now = new Date()

        const expiredSessions = await db.collection('dining_sessions')
          .where({
            status: 'active',
            deadline: _.lt(now)
          })
          .get()

        for (const session of expiredSessions.data) {
          await db.collection('dining_sessions').doc(session._id).update({
            data: {
              status: 'closed',
              closed_at: new Date()
            }
          })
        }

        return {
          success: true,
          data: {
            closedCount: expiredSessions.data.length
          }
        }

      case 'extendDeadline':
        // 延长截止时间（仅发起人）
        const { sessionId: extendSessionId, additionalMinutes } = data

        const extendSession = await getSession(extendSessionId)

        if (extendSession.created_by !== wxContext.OPENID) {
          throw new Error('只有发起点餐的用户可以延长截止时间')
        }

        const newDeadline = new Date(new Date(extendSession.deadline).getTime() + additionalMinutes * 60 * 1000)

        await db.collection('dining_sessions').doc(extendSessionId).update({
          data: {
            deadline: newDeadline
          }
        })

        return {
          success: true,
          data: {
            newDeadline: newDeadline
          }
        }
    }
  } catch (err) {
    return { success: false, errMsg: err.message }
  }
}
```

---

## 4. 页面设计

### 4.1 页面结构

```
pages/
├── ordering/
│   ├── create/            # 创建点餐会话
│   ├── session/           # 点餐会话详情
│   ├── select/            # 选择菜品
│   └── summary/           # 点餐汇总
```

### 4.2 ordering/create 页面（创建点餐）

**文件**：`pages/ordering/create/index`

#### 功能说明
- 输入点餐标题
- 选择截止时间
- 快捷选择预选菜品
- 创建成功后分享

#### WXML 结构
```xml
<view class="container">
  <view class="title-section">
    <text class="title">发起点餐</text>
    <text class="subtitle">邀请家人一起点餐</text>
  </view>

  <!-- 点餐标题 -->
  <view class="form-section">
    <text class="label">点餐标题</text>
    <input
      class="input"
      placeholder="例如：午餐点餐、晚餐点餐"
      bindinput="onTitleInput"
      value="{{title}}"
    />
  </view>

  <!-- 截止时间 -->
  <view class="form-section">
    <text class="label">截止时间</text>
    <view class="deadline-options">
      <view
        class="option {{deadlineMinutes === item}}"
        wx:for="{{deadlineOptions}}"
        wx:key="*this"
        data-minutes="{{item}}"
        bindtap="onDeadlineSelect"
      >
        {{item}}分钟
      </view>
    </view>
  </view>

  <!-- 快速添加菜品（可选） -->
  <view class="form-section">
    <text class="label">快速添加菜品（可选）</text>
    <view class="preset-tips" wx:if="{{!showPreset}}">
      <text>点击添加预选菜品</text>
      <view class="arrow">›</view>
    </view>
    <button class="select-btn" bindtap="goToSelectPreset" wx:if="{{!showPreset}}">选择菜品</button>

    <view class="preset-list" wx:if="{{presetItems.length > 0}}">
      <view class="preset-item" wx:for="{{presetItems}}" wx:key="_id">
        <image class="item-image" src="{{item.image_url}}" mode="aspectFill" />
        <text class="item-name">{{item.name}}</text>
        <text class="item-price">¥{{item.price / 100}}</text>
        <view class="remove-btn" catchtap="removePreset" data-index="{{index}}">×</view>
      </view>
    </view>
  </view>

  <!-- 创建按钮 -->
  <button class="create-btn" bindtap="createSession">发起点餐</button>

  <!-- 分享提示 -->
  <view class="share-tip" wx:if="{{createdSessionId}}">
    <text>点餐已创建，分享给家人一起点餐吧！</text>
    <button class="share-btn" open-type="share">分享到家庭群</button>
    <button class="done-btn" bindtap="goToSession">进入点餐</button>
  </view>
</view>
```

### 4.3 ordering/session 页面（会话详情）

**文件**：`pages/ordering/session/index`

#### 功能说明
- 显示会话信息（标题、截止时间）
- 显示实时汇总（总金额、参与人数）
- 显示各成员的选择
- 发起人可关闭会话

#### WXML 结构
```xml
<view class="container">
  <!-- 会话信息 -->
  <view class="session-header">
    <text class="session-title">{{session.title}}</text>
    <view class="session-info">
      <text class="deadline" wx:if="{{session.status === 'active'}}">
        截止时间：{{formatTime(session.deadline)}}
      </text>
      <text class="status {{session.status}}">{{statusText}}</text>
    </view>
  </view>

  <!-- 实时汇总 -->
  <view class="summary-card">
    <view class="summary-item">
      <text class="label">参与人数</text>
      <text class="value">{{session.order_count}} 人</text>
    </view>
    <view class="summary-item">
      <text class="label">总金额</text>
      <text class="value price">¥{{session.total_amount / 100}}</text>
    </view>
  </view>

  <!-- 各成员选择 -->
  <view class="selections-section">
    <text class="section-title">大家的選擇</text>

    <view class="selection-list" wx:if="{{selections.length > 0}}">
      <view class="selection-item" wx:for="{{selections}}" wx:key="user_openid">
        <view class="user-info">
          <image class="avatar" src="{{item.user_avatar || '/miniprogram/images/avatar.png'}}" />
          <text class="name">{{item.user_name}}</text>
        </view>
        <view class="items-info">
          <view class="item" wx:for="{{item.items}}" wx:for-item="food" wx:key="menu_item_id">
            <text class="food-name">{{food.quantity}}份 {{food.menu_item_name}}</text>
            <text class="food-note" wx:if="{{food.note}}">{{food.note}}</text>
          </view>
          <text class="subtotal">小计：¥{{item.subtotal / 100}}</text>
        </view>
      </view>
    </view>

    <view class="empty-selections" wx:else>
      <text>暂无成员选择菜品</text>
      <button class="select-btn" bindtap="goToSelect">去点餐</button>
    </view>
  </view>

  <!-- 我的选择 -->
  <view class="my-selection" wx:if="{{mySelection}}">
    <text class="section-title">我的选择</text>
    <view class="my-items">
      <view class="item" wx:for="{{mySelection.items}}" wx:key="menu_item_id">
        <text>{{item.quantity}}份 {{item.menu_item_name}}</text>
        <text class="note" wx:if="{{item.note}}">({{item.note}})</text>
      </view>
    </view>
    <button class="edit-btn" bindtap="goToSelect">修改</button>
  </view>

  <!-- 操作按钮 -->
  <view class="actions" wx:if="{{session.status === 'active'}}">
    <button class="btn-primary" bindtap="goToSelect" wx:if="{{!mySelection}}">我也要点餐</button>
    <button class="btn-primary" bindtap="goToSelect" wx:else>修改我的选择</button>

    <!-- 仅发起人可见 -->
    <view class="owner-actions" wx:if="{{isOwner}}">
      <button class="btn-secondary" bindtap="extendDeadline">延长15分钟</button>
      <button class="btn-warning" bindtap="closeSession">关闭点餐</button>
    </view>
  </view>
</view>
```

### 4.4 ordering/select 页面（选择菜品）

**文件**：`pages/ordering/select/index`

#### 功能说明
- 浏览菜单选择菜品
- 设置份数和备注
- 从收藏夹快速添加
- 查看已选菜品

#### WXML 结构
```xml
<view class="container">
  <!-- 底部已选栏 -->
  <view class="cart-bar" bindtap="showCartPanel">
    <view class="cart-icon">
      <text class="badge" wx:if="{{selectedItems.length > 0}}">{{selectedItems.length}}</text>
    </view>
    <text class="cart-total">¥{{totalPrice / 100}}</text>
    <button class="submit-btn" bindtap="submitSelection" disabled="{{selectedItems.length === 0}}">
      确定
    </button>
  </view>

  <!-- 菜品列表 -->
  <scroll-view scroll-y class="menu-scroll">
    <!-- 分类Tab -->
    <scroll-view scroll-x class="category-scroll" wx:if="{{categories.length > 0}}">
      <view class="category-list">
        <view
          class="category-item {{activeCategoryId === item._id ? 'active' : ''}}"
          wx:for="{{categories}}"
          wx:key="_id"
          data-id="{{item._id}}"
          bindtap="onCategoryTap"
        >
          {{item.name}}
        </view>
      </view>
    </scroll-view>

    <!-- 菜品 -->
    <view class="menu-list" wx:if="{{items.length > 0}}">
      <view class="menu-item" wx:for="{{items}}" wx:key="_id">
        <image class="item-image" src="{{item.image_url || '/miniprogram/images/default-goods-image.png'}}" mode="aspectFill" />
        <view class="item-info">
          <text class="item-name">{{item.name}}</text>
          <text class="item-price">¥{{item.price / 100}}</text>
        </view>
        <view class="item-actions">
          <view class="quantity-ctrl" wx:if="{{getItemQuantity(item._id) > 0}}">
            <view class="qty-btn minus" catchtap="decreaseItem" data-id="{{item._id}}">-</view>
            <text class="qty-num">{{getItemQuantity(item._id)}}</text>
          </view>
          <view class="add-btn" catchtap="addItem" data-item="{{item}}">+</view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 已选面板 -->
  <view class="cart-panel" wx:if="{{showCart}}">
    <view class="panel-mask" bindtap="hideCartPanel"></view>
    <view class="panel-content">
      <view class="panel-header">
        <text class="title">已选菜品</text>
        <text class="clear-btn" bindtap="clearAll">清空</text>
      </view>

      <scroll-view scroll-y class="selected-list">
        <view class="selected-item" wx:for="{{selectedItems}}" wx:key="menu_item_id">
          <image class="item-image" src="{{item.image_url}}" mode="aspectFill" />
          <view class="item-info">
            <text class="item-name">{{item.name}}</text>
            <text class="item-price">¥{{item.price / 100}}</text>
          </view>
          <view class="item-ctrl">
            <view class="qty-btn minus" catchtap="decreaseItem" data-id="{{item.menu_item_id}}">-</view>
            <text class="qty-num">{{item.quantity}}</text>
            <view class="qty-btn plus" catchtap="addExistingItem" data-item="{{item}}">+</view>
            <input
              class="note-input"
              placeholder="备注"
              value="{{item.note}}"
              bindinput="onNoteInput"
              data-id="{{item.menu_item_id}}"
            />
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
```

---

## 5. 开发步骤

### Step 1: 创建数据库集合
```javascript
// 在云开发控制台创建
// 1. dining_sessions
// 2. order_selections
```

### Step 2: 创建 ordering 云函数
```bash
# 在 cloudfunctions 目录下创建 ordering 云函数
```

### Step 3: 编写云函数代码
- 复制上述 ordering 云函数代码
- 部署云函数

### Step 4: 创建页面文件
```bash
# 创建页面
miniprogram/pages/ordering/create/
miniprogram/pages/ordering/session/
miniprogram/pages/ordering/select/
```

### Step 5: 添加定时任务（可选）
- 配置云函数定时触发，自动关闭过期会话

### Step 6: 测试功能
- 测试创建会话
- 测试选择菜品
- 测试实时汇总
- 测试关闭会话

---

## 6. 注意事项

1. **并发控制**：使用数据库事务或乐观锁防止并发问题
2. **价格变化**：下单时记录菜品价格，避免价格变动影响订单
3. **会话状态**：定期清理过期会话，或使用定时任务
4. **实时性**：考虑使用数据库监听实现实时更新
5. **分享功能**：使用 `onShareAppMessage` 实现分享

---

## 7. 测试用例

| 用例 | 预期结果 |
|------|----------|
| 创建点餐会话 | 创建成功，显示会话信息 |
| 有进行中会话时再次创建 | 提示已有进行中的点餐 |
| 选择菜品提交 | 提交成功，汇总更新 |
| 修改已选菜品 | 更新成功，汇总更新 |
| 关闭会话 | 会话状态变为 closed |
| 超过截止时间提交 | 提示已超过截止时间 |

---

## 8. 后续优化

- [ ] 实时更新（WebSocket/数据库监听）
- [ ] 消息订阅通知
- [ ] 一键复制订单
- [ ] 点餐模板/历史复用
- [ ] AA结算功能
