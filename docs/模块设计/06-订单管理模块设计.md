# 订单管理模块设计文档

> 模块编号：06
> 优先级：P1（第二阶段）
> 预估工作量：1天

---

## 1. 模块概述

### 1.1 功能范围
- 订单列表（筛选、搜索）
- 订单详情
- 订单状态管理
- 付款标记
- 评价入口

### 1.2 模块依赖
- 用户与家庭模块
- 点餐流程模块

---

## 2. 数据库设计

### 2.1 orders（订单表）

```javascript
// 云开发数据库集合名称：orders

{
  "_id": "ObjectId",
  "family_id": "家庭ID",
  "session_id": "点餐会话ID",
  "title": "午餐点餐",               // 订单标题
  "total_amount": 15000,             // 总金额（分）
  "status": "completed",             // completed/completed/cancelled
  "payment_status": "unpaid",        // unpaid/paid/split
  "payments": {                      // 分账记录
    "openid1": 5000,                 // 用户openid: 金额
    "openid2": 10000
  },
  "created_by": "用户openid",
  "created_at": "Date",
  "completed_at": "Date"
}

// 索引设计
db.orders.createIndex({ "family_id": 1, "created_at": -1 })
db.orders.createIndex({ "family_id": 1, "status": 1 })
db.orders.createIndex({ "session_id": 1 })
db.orders.createIndex({ "created_by": 1, "created_at": -1 })
```

### 2.2 order_items（订单明细表）

```javascript
// 云开发数据库集合名称：order_items

{
  "_id": "ObjectId",
  "order_id": "订单ID",
  "session_id": "会话ID",
  "user_openid": "用户openid",
  "user_name": "用户名（冗余）",
  "items": [
    {
      "menu_item_id": "菜品ID",
      "menu_item_name": "菜品名称",
      "menu_item_price": 3500,       // 下单时的价格
      "quantity": 2,
      "note": "不要香菜",
      "subtotal": 7000
    }
  ],
  "subtotal": 7000,                  // 该用户的小计
  "created_at": "Date"
}

// 索引设计
db.order_items.createIndex({ "order_id": 1 })
db.order_items.createIndex({ "session_id": 1, "user_openid": 1 })
```

---

## 3. 云函数设计

### 3.1 order 云函数

**文件路径**：`cloudfunctions/order/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()
const _ = db.command

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action, data } = event

  // 验证用户
  async function getUser() {
    const userRes = await db.collection('users').where({
      openid: wxContext.OPENID
    }).get()

    if (userRes.data.length === 0) {
      throw new Error('用户不存在')
    }
    return userRes.data[0]
  }

  try {
    switch (action) {
      case 'generateFromSession':
        // 从点餐会话生成订单
        const user = await getUser()
        const { sessionId } = data

        // 获取会话
        const sessionRes = await db.collection('dining_sessions').doc(sessionId).get()
        if (!sessionRes.data) {
          throw new Error('会话不存在')
        }

        const session = sessionRes.data

        if (session.status !== 'closed') {
          throw new Error('只能从已关闭的会话生成订单')
        }

        // 检查是否已生成订单
        const existingOrder = await db.collection('orders')
          .where({ session_id: sessionId })
          .get()

        if (existingOrder.data.length > 0) {
          return {
            success: true,
            data: existingOrder.data[0]
          }
        }

        // 获取所有选择
        const selectionsRes = await db.collection('order_selections')
          .where({ session_id: sessionId })
          .get()

        if (selectionsRes.data.length === 0) {
          throw new Error('没有菜品选择')
        }

        // 创建订单
        const orderRes = await db.collection('orders').add({
          data: {
            family_id: session.family_id,
            session_id: sessionId,
            title: session.title,
            total_amount: session.total_amount,
            status: 'completed',
            payment_status: 'unpaid',
            payments: {},
            created_by: wxContext.OPENID,
            created_at: new Date(),
            completed_at: new Date()
          }
        })

        // 创建订单明细
        for (const selection of selectionsRes.data) {
          await db.collection('order_items').add({
            data: {
              order_id: orderRes._id,
              session_id: sessionId,
              user_openid: selection.user_openid,
              user_name: selection.user_name,
              items: selection.items.map(item => ({
                ...item,
                menu_item_price: item.menu_item_price,
                subtotal: item.menu_item_price * item.quantity
              })),
              subtotal: selection.subtotal,
              created_at: new Date()
            }
          })
        }

        return {
          success: true,
          data: {
            orderId: orderRes._id
          }
        }

      case 'list':
        // 获取订单列表
        const { familyId, status, page = 1, pageSize = 10 } = data

        let query = db.collection('orders')
          .where({ family_id: familyId })

        if (status) {
          query = query.where({ status: status })
        }

        const ordersRes = await query
          .orderBy('created_at', 'desc')
          .skip((page - 1) * pageSize)
          .limit(pageSize)
          .get()

        const totalRes = await db.collection('orders')
          .where({ family_id: familyId })
          .count()

        return {
          success: true,
          data: {
            list: ordersRes.data,
            total: totalRes.total
          }
        }

      case 'getDetail':
        // 获取订单详情
        const { orderId } = data

        const order = await db.collection('orders').doc(orderId).get()
        if (!order.data) {
          throw new Error('订单不存在')
        }

        // 获取订单明细
        const itemsRes = await db.collection('order_items')
          .where({ order_id: orderId })
          .get()

        return {
          success: true,
          data: {
            order: order.data,
            items: itemsRes.data
          }
        }

      case 'markPaid':
        // 标记付款
        const { orderId: paidOrderId, paidUserOpenid, amount } = data

        const paidOrder = await db.collection('orders').doc(paidOrderId).get()
        if (!paidOrder.data) {
          throw new Error('订单不存在')
        }

        const payments = paidOrder.data.payments || {}
        payments[paidUserOpenid] = (payments[paidUserOpenid] || 0) + amount

        // 检查是否全付
        const totalPaid = Object.values(payments).reduce((sum, v) => sum + v, 0)
        const isFullPaid = totalPaid >= paidOrder.data.total_amount

        await db.collection('orders').doc(paidOrderId).update({
          data: {
            payments: payments,
            payment_status: isFullPaid ? 'paid' : 'split',
            updated_at: new Date()
          }
        })

        return { success: true }

      case 'getStatistics':
        // 获取订单统计
        const { familyId: statsFamilyId, startDate, endDate } = data

        let matchStage = {
          family_id: statsFamilyId,
          status: 'completed'
        }

        if (startDate || endDate) {
          matchStage.created_at = {}
          if (startDate) matchStage.created_at.$gte = new Date(startDate)
          if (endDate) matchStage.created_at.$lte = new Date(endDate)
        }

        const statsRes = await db.collection('orders')
          .aggregate()
          .match(matchStage)
          .group({
            _id: null,
            totalAmount: _.sum('$total_amount'),
            orderCount: _.sum(1),
            avgAmount: _.avg('$total_amount')
          })
          .end()

        // 按日统计
        const dailyRes = await db.collection('orders')
          .aggregate()
          .match(matchStage)
          .group({
            _id: {
              year: _.year('$created_at'),
              month: _.month('$created_at'),
              day: _.dayOfMonth('$created_at')
            },
            amount: _.sum('$total_amount'),
            count: _.sum(1)
          })
          .sort({ '_id': -1 })
          .limit(30)
          .end()

        return {
          success: true,
          data: {
            summary: statsRes.list[0] || { totalAmount: 0, orderCount: 0, avgAmount: 0 },
            daily: dailyRes.list
          }
        }

      case 'delete':
        // 删除订单（软删除）
        const { orderId: delOrderId } = data

        await db.collection('orders').doc(delOrderId).update({
          data: {
            status: 'cancelled',
            updated_at: new Date()
          }
        })

        return { success: true }

      case 'getMyOrders':
        // 获取我的订单（我参与的）
        const { familyId: myFamilyId, page = 1, pageSize = 10 } = data

        // 先获取订单ID列表
        const myItemsRes = await db.collection('order_items')
          .where({
            family_id: myFamilyId,
            user_openid: wxContext.OPENID
          })
          .skip((page - 1) * pageSize)
          .limit(pageSize)
          .get()

        const orderIds = myItemsRes.data.map(item => item.order_id)

        if (orderIds.length === 0) {
          return {
            success: true,
            data: {
              list: [],
              total: 0
            }
          }
        }

        const myOrdersRes = await db.collection('orders')
          .where({
            _id: _.in(orderIds)
          })
          .orderBy('created_at', 'desc')
          .get()

        const totalCountRes = await db.collection('order_items')
          .where({
            family_id: myFamilyId,
            user_openid: wxContext.OPENID
          })
          .count()

        return {
          success: true,
          data: {
            list: myOrdersRes.data,
            total: totalCountRes.total
          }
        }
    }
  } catch (err) {
    return { success: false, errMsg: err.message }
  }
}
```

---

## 4. 页面设计

### 4.1 页面结构

```
pages/
└── orders/
    ├── index/              # 订单列表
    └── detail/             # 订单详情
```

### 4.2 orders/index 页面（订单列表）

**文件**：`pages/orders/index/index`

#### 功能说明
- 显示订单列表
- 支持筛选（时间、状态）
- 显示订单概要信息

#### WXML 结构
```xml
<view class="container">
  <!-- 筛选栏 -->
  <view class="filter-bar">
    <view class="filter-tabs">
      <view
        class="tab {{activeFilter === 'all' ? 'active' : ''}}"
        data-filter="all"
        bindtap="onFilterTap"
      >全部</view>
      <view
        class="tab {{activeFilter === 'today' ? 'active' : ''}}"
        data-filter="today"
        bindtap="onFilterTap"
      >今日</view>
      <view
        class="tab {{activeFilter === 'week' ? 'active' : ''}}"
        data-filter="week"
        bindtap="onFilterTap"
      >本周</view>
      <view
        class="tab {{activeFilter === 'month' ? 'active' : ''}}"
        data-filter="month"
        bindtap="onFilterTap"
      >本月</view>
    </view>
  </view>

  <!-- 订单列表 -->
  <view class="order-list" wx:if="{{list.length > 0}}">
    <view
      class="order-card"
      wx:for="{{list}}"
      wx:key="_id"
      bindtap="goToDetail"
      data-id="{{item._id}}"
    >
      <view class="order-header">
        <text class="order-title">{{item.title}}</text>
        <text class="order-status {{item.payment_status}}">
          {{paymentStatusText[item.payment_status]}}
        </text>
      </view>

      <view class="order-info">
        <text class="order-date">{{formatDate(item.created_at)}}</text>
        <text class="order-count">{{item.order_count || '已结束'}}</text>
      </view>

      <view class="order-footer">
        <text class="order-amount">¥{{item.total_amount / 100}}</text>
        <text class="order-action">查看详情 ›</text>
      </view>
    </view>
  </view>

  <view class="empty-state" wx:if="{{list.length === 0 && !loading}}">
    <image class="empty-icon" src="/miniprogram/images/empty-order.png" />
    <text class="empty-text">暂无订单</text>
    <button class="go-menu-btn" bindtap="goToMenu">去点餐</button>
  </view>

  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{hasMore && list.length > 0}}">
    <text>{{loading ? '加载中...' : '上拉加载更多'}}</text>
  </view>
</view>
```

### 4.3 orders/detail 页面（订单详情）

**文件**：`pages/orders/detail/index`

#### 功能说明
- 显示订单完整信息
- 显示各成员的选择明细
- 标记付款状态
- 跳转评价入口

#### WXML 结构
```xml
<view class="container">
  <!-- 订单信息 -->
  <view class="order-info-card">
    <view class="info-row">
      <text class="label">订单编号</text>
      <text class="value">{{order._id}}</text>
    </view>
    <view class="info-row">
      <text class="label">点餐时间</text>
      <text class="value">{{formatDate(order.created_at)}}</text>
    </view>
    <view class="info-row">
      <text class="label">付款状态</text>
      <text class="value status {{order.payment_status}}">
        {{paymentStatusText[order.payment_status]}}
      </text>
    </view>
  </view>

  <!-- 各成员选择 -->
  <view class="selections-section" wx:if="{{items.length > 0}}">
    <text class="section-title">成员点餐明细</text>

    <view class="selection-group" wx:for="{{items}}" wx:key="user_openid">
      <view class="group-header">
        <image class="avatar" src="{{item.user_avatar || '/miniprogram/images/avatar.png'}}" />
        <text class="name">{{item.user_name}}</text>
        <text class="subtotal">¥{{item.subtotal / 100}}</text>
      </view>

      <view class="food-list">
        <view class="food-item" wx:for="{{item.items}}" wx:for-item="food" wx:key="menu_item_id">
          <text class="food-name">{{food.quantity}}份 {{food.menu_item_name}}</text>
          <text class="food-note" wx:if="{{food.note}}">{{food.note}}</text>
          <text class="food-price">¥{{food.subtotal / 100}}</text>
        </view>
      </view>

      <!-- 付款按钮 -->
      <view class="pay-action" wx:if="{{order.payment_status !== 'paid' && item.user_openid === myOpenid}}">
        <button class="pay-btn" bindtap="markMyPaid">我已付款</button>
      </view>
    </view>
  </view>

  <!-- 总计 -->
  <view class="total-section">
    <view class="total-row">
      <text class="label">订单总计</text>
      <text class="amount">¥{{order.total_amount / 100}}</text>
    </view>
    <view class="total-row" wx:if="{{order.payments && Object.keys(order.payments).length > 0}}">
      <text class="label">已付</text>
      <text class="paid-amount">¥{{paidAmount / 100}}</text>
    </view>
  </view>

  <!-- 评价入口 -->
  <view class="review-entry" wx:if="{{order.payment_status === 'paid'}}">
    <button class="review-btn" bindtap="goToReview">评价订单</button>
  </view>

  <!-- 操作按钮 -->
  <view class="actions">
    <button class="action-btn share" open-type="share">分享订单</button>
    <button class="action-btn repeat" bindtap="repeatOrder">再来一单</button>
  </view>
</view>
```

#### JS 逻辑
```javascript
Page({
  data: {
    orderId: '',
    order: {},
    items: [],
    myOpenid: '',
    paymentStatusText: {
      'unpaid': '待付款',
      'split': '部分付款',
      'paid': '已付清'
    }
  },

  onLoad(options) {
    if (options.id) {
      this.setData({ orderId: options.id })
      this.getDetail()
    }
  },

  async getDetail() {
    wx.showLoading({ title: '加载中...' })

    try {
      const res = await wx.cloud.callFunction({
        name: 'order',
        data: {
          action: 'getDetail',
          orderId: this.data.orderId
        }
      })

      wx.hideLoading()

      if (res.result.success) {
        this.setData({
          order: res.result.data.order,
          items: res.result.data.items
        })

        // 获取我的openid
        const userRes = await wx.cloud.callFunction({
          name: 'auth',
          data: { action: 'login' }
        })
        this.setData({
          myOpenid: userRes.result.data.user?.openid
        })
      } else {
        wx.showToast({ title: res.result.errMsg, icon: 'none' })
      }
    } catch (err) {
      wx.hideLoading()
      wx.showToast({ title: '加载失败', icon: 'none' })
    }
  },

  async markMyPaid() {
    const myItems = this.data.items.find(
      item => item.user_openid === this.data.myOpenid
    )

    if (!myItems) return

    wx.showModal({
      title: '确认付款',
      content: `确认已付 ¥${myItems.subtotal / 100}？`,
      success: async (res) => {
        if (res.confirm) {
          try {
            const result = await wx.cloud.callFunction({
              name: 'order',
              data: {
                action: 'markPaid',
                orderId: this.data.orderId,
                paidUserOpenid: this.data.myOpenid,
                amount: myItems.subtotal
              }
            })

            if (result.result.success) {
              wx.showToast({ title: '付款成功', icon: 'success' })
              this.getDetail()
            } else {
              wx.showToast({ title: result.result.errMsg, icon: 'none' })
            }
          } catch (err) {
            wx.showToast({ title: '付款失败', icon: 'none' })
          }
        }
      }
    })
  },

  goToReview() {
    const orderItems = this.data.items.find(
      item => item.user_openid === this.data.myOpenid
    )

    const itemIds = orderItems?.items.map(i => i.menu_item_id) || []

    wx.navigateTo({
      url: `/pages/review/create?orderId=${this.data.orderId}&itemIds=${JSON.stringify(itemIds)}`
    })
  },

  repeatOrder() {
    // 跳转到点餐页面，携带之前的菜品
    const presetItems = this.data.items.flatMap(item =>
      item.items.map(i => ({
        _id: i.menu_item_id,
        name: i.menu_item_name,
        price: i.menu_item_price / 100,
        image_url: ''
      }))
    )

    const encoded = encodeURIComponent(JSON.stringify(presetItems))
    wx.navigateTo({
      url: `/pages/ordering/create?presetItems=${encoded}`
    })
  },

  onShareAppMessage() {
    return {
      title: `${this.data.order.title} - ¥${this.data.order.total_amount / 100}`,
      path: `/pages/orders/detail?id=${this.data.orderId}`
    }
  }
})
```

---

## 5. 开发步骤

### Step 1: 创建数据库集合
```javascript
// 在云开发控制台创建
// 1. orders
// 2. order_items
```

### Step 2: 创建 order 云函数
```bash
# 在 cloudfunctions 目录下创建 order 云函数
```

### Step 3: 编写云函数代码
- 复制上述 order 云函数代码
- 部署云函数

### Step 4: 创建页面文件
```bash
# 创建页面
miniprogram/pages/orders/index/
miniprogram/pages/orders/detail/
```

### Step 5: 在点餐流程中集成
- 点餐会话关闭后，自动生成订单

### Step 6: 测试功能
- 测试生成订单
- 测试订单列表
- 测试付款标记
- 测试订单详情

---

## 6. 注意事项

1. **订单生成时机**：会话关闭时生成订单，或按需生成
2. **金额精度**：所有金额以"分"存储和计算
3. **权限控制**：只能查看本家庭的订单
4. **历史数据保留**：订单数据建议长期保留用于统计

---

## 7. 测试用例

| 用例 | 预期结果 |
|------|----------|
| 关闭会话后生成订单 | 订单创建成功 |
| 订单列表筛选 | 显示符合条件的订单 |
| 标记付款 | 付款记录更新 |
| 查看订单详情 | 显示完整明细 |
| 重复订单 | 携带菜品跳转创建页 |

---

## 8. 后续优化

- [ ] 分账功能（AA付款）
- [ ] 订单导出
- [ ] 周期性订单（每日点餐模板）
- [ ] 订单合并
- [ ] 电子发票
