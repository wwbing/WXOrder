# 用户与家庭模块设计文档

> 模块编号：01
> 优先级：P0（第一阶段）
> 预估工作量：1天

---

## 1. 模块概述

### 1.1 功能范围
- 用户微信登录
- 创建新家庭
- 加入已有家庭
- 家庭成员管理
- 用户信息管理

### 1.2 模块依赖
- 无（基础模块）

---

## 2. 数据库设计

### 2.1 collections（家庭表）

```javascript
// 云开发数据库集合名称：families

{
  "_id": "ObjectId",
  "name": "我家",                    // 家庭名称
  "owner_openid": "微信openid",      // 创建者openid
  "invite_code": "ABC123",           // 6位邀请码（唯一）
  "member_count": 1,                 // 成员数量
  "settings": {
    "currency": "CNY",               // 货币单位
    "timezone": "Asia/Shanghai",     // 时区
    "default_deadline_minutes": 60   // 默认截止时间（分钟）
  },
  "created_at": "Date",
  "updated_at": "Date"
}

// 索引设计
db.families.createIndex({ "invite_code": 1 }, { unique: true })
db.families.createIndex({ "owner_openid": 1 })
db.families.createIndex({ "created_at": -1 })
```

### 2.2 users（用户表）

```javascript
// 云开发数据库集合名称：users

{
  "_id": "ObjectId",
  "openid": "微信openid",            // 主键
  "nickname": "用户昵称",
  "avatar_url": "头像URL",
  "family_id": "家庭ID",
  "role": "admin|member",            // admin:创建者, member:普通成员
  "taste_preferences": {             // 口味偏好
    "avoid_cilantro": false,         // 不吃香菜
    "no_spicy": false,               // 不吃辣
    "vegetarian": false,             // 素食主义者
    "custom": []                     // 自定义标签
  },
  "notification_enabled": true,      // 消息通知开关
  "created_at": "Date",
  "updated_at": "Date"
}

// 索引设计
db.users.createIndex({ "openid": 1 }, { unique: true })
db.users.createIndex({ "family_id": 1 })
```

---

## 3. 云函数设计

### 3.1 auth 云函数

**文件路径**：`cloudfunctions/auth/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

// 生成6位邀请码
function generateInviteCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
  let code = ''
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length))
  }
  return code
}

// 检查邀请码是否已存在
async function checkInviteCodeExists(code) {
  const res = await db.collection('families').where({
    invite_code: code
  }).count()
  return res.total > 0
}

// 生成唯一邀请码
async function generateUniqueInviteCode() {
  let code = generateInviteCode()
  while (await checkInviteCodeExists(code)) {
    code = generateInviteCode()
  }
  return code
}

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action } = event

  switch (action) {
    case 'login':
      // 用户登录/注册
      try {
        // 查询用户是否已存在
        const userRes = await db.collection('users').where({
          openid: wxContext.OPENID
        }).get()

        if (userRes.data.length > 0) {
          // 用户已存在，返回用户信息和家庭信息
          const user = userRes.data[0]
          let familyInfo = null
          if (user.family_id) {
            const familyRes = await db.collection('families').doc(user.family_id).get()
            familyInfo = familyRes.data
          }
          return {
            success: true,
            data: {
              isNew: false,
              user: user,
              family: familyInfo
            }
          }
        } else {
          // 新用户，返回引导创建/加入家庭
          return {
            success: true,
            data: {
              isNew: true,
              user: null,
              family: null
            }
          }
        }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }

    case 'createFamily':
      // 创建新家庭
      try {
        const { familyName, userInfo } = event

        // 生成唯一邀请码
        const inviteCode = await generateUniqueInviteInviteCode()

        // 创建家庭
        const familyRes = await db.collection('families').add({
          data: {
            name: familyName || '我家',
            owner_openid: wxContext.OPENID,
            invite_code: inviteCode,
            member_count: 1,
            settings: {
              currency: 'CNY',
              timezone: 'Asia/Shanghai',
              default_deadline_minutes: 60
            },
            created_at: new Date(),
            updated_at: new Date()
          }
        })

        // 创建用户记录
        await db.collection('users').add({
          data: {
            openid: wxContext.OPENID,
            nickname: userInfo.nickName || '家庭成员',
            avatar_url: userInfo.avatarUrl || '',
            family_id: familyRes._id,
            role: 'admin',
            taste_preferences: {
              avoid_cilantro: false,
              no_spicy: false,
              vegetarian: false,
              custom: []
            },
            notification_enabled: true,
            created_at: new Date(),
            updated_at: new Date()
          }
        })

        return {
          success: true,
          data: {
            familyId: familyRes._id,
            inviteCode: inviteCode
          }
        }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }

    case 'joinFamily':
      // 加入已有家庭
      try {
        const { inviteCode, userInfo } = event

        // 查找家庭
        const familyRes = await db.collection('families').where({
          invite_code: inviteCode.toUpperCase()
        }).get()

        if (familyRes.data.length === 0) {
          return { success: false, errMsg: '邀请码不存在' }
        }

        const family = familyRes.data[0]

        // 检查用户是否已在该家庭
        const userRes = await db.collection('users').where({
          openid: wxContext.OPENID,
          family_id: family._id
        }).get()

        if (userRes.data.length > 0) {
          return { success: false, errMsg: '您已加入该家庭' }
        }

        // 更新用户家庭信息
        await db.collection('users').where({
          openid: wxContext.OPENID
        }).update({
          data: {
            family_id: family._id,
            role: 'member',
            updated_at: new Date()
          }
        })

        // 更新家庭成员数量
        await db.collection('families').doc(family._id).update({
          data: {
            member_count: db.command.inc(1),
            updated_at: new Date()
          }
        })

        return {
          success: true,
          data: {
            familyId: family._id,
            familyName: family.name
          }
        }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }

    case 'getFamilyMembers':
      // 获取家庭成员列表
      try {
        const { familyId } = event

        const membersRes = await db.collection('users').where({
          family_id: familyId
        }).get()

        return {
          success: true,
          data: membersRes.data
        }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }

    case 'updateUserProfile':
      // 更新用户信息
      try {
        const { nickname, tastePreferences, notificationEnabled } = event

        const updateData = {
          updated_at: new Date()
        }

        if (nickname) updateData.nickname = nickname
        if (tastePreferences) updateData.taste_preferences = tastePreferences
        if (notificationEnabled !== undefined) {
          updateData.notification_enabled = notificationEnabled
        }

        await db.collection('users').where({
          openid: wxContext.OPENID
        }).update({
          data: updateData
        })

        return { success: true }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }

    case 'leaveFamily':
      // 退出家庭
      try {
        const userRes = await db.collection('users').where({
          openid: wxContext.OPENID
        }).get()

        if (userRes.data.length === 0) {
          return { success: false, errMsg: '用户不存在' }
        }

        const user = userRes.data[0]

        if (user.role === 'admin') {
          return { success: false, errMsg: '管理员无法退出，请先转让家庭所有权' }
        }

        // 清空用户的家庭ID
        await db.collection('users').doc(user._id).update({
          data: {
            family_id: '',
            role: 'member',
            updated_at: new Date()
          }
        })

        // 减少家庭成员数量
        if (user.family_id) {
          await db.collection('families').doc(user.family_id).update({
            data: {
              member_count: db.command.inc(-1),
              updated_at: new Date()
            }
          })
        }

        return { success: true }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }

    case 'getInviteCode':
      // 获取家庭邀请码
      try {
        const userRes = await db.collection('users').where({
          openid: wxContext.OPENID
        }).get()

        if (userRes.data.length === 0) {
          return { success: false, errMsg: '用户不存在' }
        }

        const user = userRes.data[0]

        if (!user.family_id) {
          return { success: false, errMsg: '您还没有加入家庭' }
        }

        const familyRes = await db.collection('families').doc(user.family_id).get()

        return {
          success: true,
          data: {
            inviteCode: familyRes.data.invite_code,
            familyName: familyRes.data.name
          }
        }
      } catch (err) {
        return { success: false, errMsg: err.message }
      }
  }
}
```

---

## 4. 页面设计

### 4.1 页面结构

```
pages/
├── auth/
│   └── login/              # 登录页（创建/加入家庭）
└── profile/
    ├── index/              # 个人中心
    └── settings/           # 设置页
```

### 4.2 login 页面（登录页）

**文件**：`pages/auth/login/index`

#### 功能说明
- 新用户：引导创建家庭或输入邀请码加入
- 老用户：直接显示家庭信息和成员列表

#### WXML 结构
```xml
<view class="container">
  <!-- 新用户：创建/加入家庭 -->
  <block wx:if="{{isNewUser}}">
    <view class="title">欢迎使用家庭点餐</view>
    <view class="subtitle">请选择操作</view>

    <view class="card">
      <view class="card-title">创建新家庭</view>
      <input class="input" placeholder="家庭名称（可选）" bindinput="onFamilyNameInput" />
      <button class="btn-primary" bindtap="createFamily">创建家庭</button>
    </view>

    <view class="divider">或</view>

    <view class="card">
      <view class="card-title">加入已有家庭</view>
      <input class="input" placeholder="请输入邀请码" bindinput="onInviteCodeInput" />
      <button class="btn-primary" bindtap="joinFamily">加入家庭</button>
    </view>
  </block>

  <!-- 老用户：显示家庭信息 -->
  <block wx:else>
    <view class="welcome">欢迎回来，{{userInfo.nickName}}</view>

    <view class="family-card" bindtap="goToFamily">
      <view class="family-name">{{familyInfo.name}}</view>
      <view class="member-count">成员：{{familyInfo.member_count}}人</view>
      <view class="invite-code">邀请码：{{familyInfo.invite_code}}</view>
    </view>

    <button class="btn-primary" bindtap="goToMenu">进入菜单</button>
    <button class="btn-secondary" bindtap="goToProfile">个人中心</button>
  </block>
</view>
```

#### JS 逻辑
```javascript
Page({
  data: {
    isNewUser: true,
    userInfo: null,
    familyInfo: null,
    familyName: '',
    inviteCode: ''
  },

  onLoad() {
    this.checkLoginStatus()
  },

  // 检查登录状态
  async checkLoginStatus() {
    wx.showLoading({ title: '加载中...' })
    try {
      const res = await wx.cloud.callFunction({
        name: 'auth',
        data: { action: 'login' }
      })
      wx.hideLoading()

      if (res.result.success) {
        this.setData({
          isNewUser: res.result.data.isNew,
          userInfo: res.result.data.user,
          familyInfo: res.result.data.family
        })
      } else {
        wx.showToast({ title: res.result.errMsg, icon: 'none' })
      }
    } catch (err) {
      wx.hideLoading()
      wx.showToast({ title: '登录失败', icon: 'none' })
    }
  },

  // 输入家庭名称
  onFamilyNameInput(e) {
    this.setData({ familyName: e.detail.value })
  },

  // 输入邀请码
  onInviteCodeInput(e) {
    this.setData({
      inviteCode: e.detail.value.toUpperCase()
    })
  },

  // 创建家庭
  async createFamily() {
    try {
      const userProfile = await this.getUserProfile()

      wx.showLoading({ title: '创建中...' })
      const res = await wx.cloud.callFunction({
        name: 'auth',
        data: {
          action: 'createFamily',
          familyName: this.data.familyName,
          userInfo: userProfile
        }
      })
      wx.hideLoading()

      if (res.result.success) {
        wx.showToast({ title: '创建成功', icon: 'success' })
        this.checkLoginStatus()
      } else {
        wx.showToast({ title: res.result.errMsg, icon: 'none' })
      }
    } catch (err) {
      wx.hideLoading()
      wx.showToast({ title: '创建失败', icon: 'none' })
    }
  },

  // 加入家庭
  async joinFamily() {
    if (!this.data.inviteCode || this.data.inviteCode.length !== 6) {
      wx.showToast({ title: '请输入6位邀请码', icon: 'none' })
      return
    }

    try {
      const userProfile = await this.getUserProfile()

      wx.showLoading({ title: '加入中...' })
      const res = await wx.cloud.callFunction({
        name: 'auth',
        data: {
          action: 'joinFamily',
          inviteCode: this.data.inviteCode,
          userInfo: userProfile
        }
      })
      wx.hideLoading()

      if (res.result.success) {
        wx.showToast({ title: '加入成功', icon: 'success' })
        this.checkLoginStatus()
      } else {
        wx.showToast({ title: res.result.errMsg, icon: 'none' })
      }
    } catch (err) {
      wx.hideLoading()
      wx.showToast({ title: '加入失败', icon: 'none' })
    }
  },

  // 获取用户信息
  getUserProfile() {
    return new Promise((resolve, reject) => {
      wx.getUserProfile({
        desc: '用于完善用户信息',
        success: (res) => {
          resolve(res.userInfo)
        },
        fail: (err) => {
          // 如果用户拒绝，也继续使用默认信息
          resolve({ nickName: '家庭成员', avatarUrl: '' })
        }
      })
    })
  },

  goToMenu() {
    wx.switchTab({ url: '/pages/menu/index' })
  },

  goToProfile() {
    wx.navigateTo({ url: '/pages/profile/index' })
  }
})
```

### 4.3 profile/index 页面（个人中心）

**文件**：`pages/profile/index/index`

#### 功能说明
- 显示用户头像、昵称
- 显示家庭信息
- 显示口味偏好标签
- 快捷入口：菜单管理、设置

---

## 5. 开发步骤

### Step 1: 创建数据库集合
```javascript
// 在云开发控制台创建以下集合
// 1. families
// 2. users
```

### Step 2: 创建 auth 云函数
```bash
# 在 cloudfunctions 目录下创建 auth 云函数
# 使用微信开发者工具右键 -> 新建Node.js云函数 -> auth
```

### Step 3: 编写云函数代码
- 复制上述 auth 云函数代码

### Step 4: 部署云函数
- 右键点击 auth 文件夹 -> 上传并部署

### Step 5: 创建页面文件
```bash
# 创建页面结构
miniprogram/pages/auth/login/
miniprogram/pages/profile/index/
```

### Step 6: 配置页面路由
在 `app.json` 中添加页面配置

### Step 7: 测试功能
- 测试登录
- 测试创建家庭
- 测试加入家庭

---

## 6. 注意事项

1. **用户隐私**：获取用户信息需要使用 `wx.getUserProfile`，注意2021年微信调整了接口策略
2. **邀请码唯一性**：确保邀请码不重复
3. **权限检查**：所有操作都需要验证用户身份（通过 openid）
4. **成员数量限制**：建议设置家庭成员上限（如20人）
5. **转让家庭**：管理员退出前需要先转让所有权

---

## 7. 测试用例

| 用例 | 预期结果 |
|------|----------|
| 新用户首次打开 | 显示创建/加入家庭界面 |
| 创建家庭 | 成功创建并显示家庭信息 |
| 输入正确邀请码加入 | 成功加入并显示家庭信息 |
| 输入错误邀请码 | 提示邀请码不存在 |
| 重复加入同一家庭 | 提示已加入该家庭 |
| 管理员尝试退出 | 提示无法退出，需先转让 |

---

## 8. 后续优化

- [ ] 支持家庭转让
- [ ] 支持修改邀请码
- [ ] 支持设置家庭管理员
- [ ] 支持消息订阅通知
