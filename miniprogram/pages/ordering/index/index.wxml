<!--pages/ordering/index/index.wxml-->
<view class="container page-ordering-index">
  <!-- Active Session Dashboard -->
  <view class="dashboard-section" wx:if="{{activeSession}}">
    <view class="session-card">
      <view class="card-header-gradient">
        <view class="header-content">
          <view class="title-row">
            <text class="session-title">{{activeSession.title}}</text>
            <view class="status-badge" wx:if="{{isCreator}}">æˆ‘çš„å‘å¸ƒ</view>
          </view>
          <view class="countdown-wrapper" wx:if="{{timeLeft}}">
            <text class="countdown-icon">â°</text>
            <text class="countdown-text">å‰©ä½™ {{timeLeft}}</text>
          </view>
          <view class="countdown-wrapper" wx:else>
            <text class="countdown-text">å·²æˆªæ­¢</text>
          </view>
        </view>
      </view>

      <view class="stats-row">
        <view class="stat-item">
          <text class="stat-num">{{summary.totalQuantity || 0}}</text>
          <text class="stat-desc">ä»½é¤å“</text>
        </view>
        <view class="divider-vert"></view>
        <view class="stat-item">
          <text class="stat-num highlight">Â¥{{(summary.totalAmount || 0) / 100}}</text>
          <text class="stat-desc">æ€»é‡‘é¢</text>
        </view>
        <view class="divider-vert"></view>
        <view class="stat-item">
          <text class="stat-num">{{summary.orderCount || 0}}</text>
          <text class="stat-desc">äººå‚ä¸</text>
        </view>
      </view>

      <!-- Participants Avatars -->
      <view class="participants-preview" wx:if="{{summary.selections && summary.selections.length > 0}}">
        <view class="avatars-row">
          <image 
            class="avatar-circle" 
            wx:for="{{summary.selections}}" 
            wx:key="_id" 
            src="{{item.user_avatar || defaultAvatar}}" 
            mode="aspectFill"
            style="z-index: {{100 - index}}"
          />
        </view>
        <text class="participants-label">æ­£åœ¨ä¸€èµ·ç‚¹é¤</text>
      </view>
    </view>

    <!-- Detailed Summary List -->
    <view class="detail-card" wx:if="{{summary.summary && summary.summary.length > 0}}">
      <view class="card-title-row">
        <text class="card-strong-title">å·²ç‚¹æ¸…å•</text>
      </view>
      <view class="summary-list">
        <view class="summary-row" wx:for="{{summary.summary}}" wx:key="itemId">
          <image class="row-img" src="{{item.item.image_url || defaultImage}}" mode="aspectFill" />
          <view class="row-info">
            <text class="row-name">{{item.item.name}}</text>
            <text class="row-unit-price">Â¥{{item.item.price / 100}}</text>
          </view>
          <view class="row-total">
            <text class="row-qty">x{{item.totalQuantity}}</text>
            <text class="row-amount">Â¥{{item.totalAmount / 100}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Member Details (List View) -->
    <view class="detail-card" wx:if="{{summary.selections && summary.selections.length > 0}}">
       <view class="card-title-row">
        <text class="card-strong-title">æˆå‘˜æ˜ç»†</text>
      </view>
      <view class="member-list">
        <view class="member-row" wx:for="{{summary.selections}}" wx:key="_id">
          <view class="member-left">
            <image class="member-face" src="{{item.user_avatar || defaultAvatar}}" mode="aspectFill" />
            <text class="member-nick">{{item.user_name}}</text>
          </view>
          <text class="member-consume">Â¥{{item.subtotal / 100}}</text>
        </view>
      </view>
    </view>

    <!-- Action Buttons -->
    <view class="action-footer">
      <button class="btn-main-action" bindtap="onEditMyOrder">
        <text>ğŸ½ï¸ ä¿®æ”¹æˆ‘çš„èœå•</text>
      </button>
      
      <view class="admin-actions" wx:if="{{isCreator}}">
        <button class="btn-secondary-action cancel" bindtap="onCancelSession">
          å–æ¶ˆ
        </button>
        <button class="btn-secondary-action confirm" bindtap="onCloseSession">
          âœ… ç¡®è®¤å®Œæˆ
        </button>
      </view>
    </view>
  </view>

  <!-- Empty State / No Active Session -->
  <view class="empty-state-container" wx:if="{{!activeSession && !loading}}">
    <view class="dashed-circle">
      <text class="large-icon">ğŸ¥˜</text>
    </view>
    <text class="empty-h1">æš‚æ— è¿›è¡Œä¸­çš„ç‚¹é¤</text>
    <text class="empty-p">å‘èµ·ä¸€ä¸ªç‚¹é¤ï¼Œå‘¼å”¤å®¶äººä¸€èµ·é€‰ç¾é£Ÿå§</text>
    <button class="btn-start-large" bindtap="onStartOrdering">
      å‘èµ·æ–°ç‚¹é¤
    </button>
  </view>

  <!-- Create Session Popup -->
  <view class="popup-mask {{showCreatePopup ? 'show' : ''}}" bindtap="closePopup"></view>
  <view class="popup-modal {{showCreatePopup ? 'show' : ''}}">
    <view class="popup-top">
      <text class="popup-header-title">æ–°çš„èšé¤</text>
      <view class="close-icon" bindtap="closePopup">Ã—</view>
    </view>

    <view class="form-body">
      <view class="form-item">
        <label>ç»™è¿™æ¬¡èšé¤èµ·ä¸ªåå­—</label>
        <input class="modern-input" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«å¤§é¤" placeholder-class="ph" bindinput="onTitleInput" value="{{createForm.title}}" />
      </view>

      <view class="form-item">
        <label>å¤§å®¶é€‰é¤çš„æ—¶é—´</label>
        <scroll-view scroll-x class="chips-scroll" enable-flex>
          <view 
            class="time-chip {{createForm.deadlineMinutes === item.value ? 'selected' : ''}}"
            wx:for="{{deadlineOptions}}"
            wx:key="value"
            bindtap="onDeadlineSelect"
            data-value="{{item.value}}"
          >
            {{item.label}}
          </view>
        </scroll-view>
      </view>
    </view>

    <button class="btn-create-confirm" bindtap="onCreateSession">ç«‹å³å‘èµ·</button>
  </view>

  <!-- Loading -->
  <view class="loading-overlay" wx:if="{{loading}}">
     <view class="spinner"></view>
  </view>
</view>
