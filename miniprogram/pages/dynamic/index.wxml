<!--pages/dynamic/index.wxml-->
<wxs module="utils">
  var formatTime = function(date) {
    if (!date) return ''
    var d = getDate(date)
    var now = getDate()
    var diff = now.getTime() - d.getTime()
    var minutes = Math.floor(diff / 60000)
    
    if (minutes < 1) return 'åˆšåˆš'
    if (minutes < 60) return minutes + 'åˆ†é’Ÿå‰'
    
    var hours = Math.floor(minutes / 60)
    if (hours < 24) return hours + 'å°æ—¶å‰'
    
    var days = Math.floor(hours / 24)
    if (days < 7) return days + 'å¤©å‰'
    
    return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate()
  }
  
  module.exports.formatTime = formatTime
</wxs>

<view class="dynamic-container">
  
  <!-- Header Tabs -->
  <view class="tabs-header">
    <view class="tab-item {{activeTab === 'pending' ? 'active' : ''}}" bindtap="onTabSwitch" data-tab="pending">
      å¾…æ¥å•
    </view>
    <view class="tab-item {{activeTab === 'cooking' ? 'active' : ''}}" bindtap="onTabSwitch" data-tab="cooking">
      çƒ¹é¥ªä¸­
    </view>
    <view class="tab-item {{activeTab === 'completed' ? 'active' : ''}}" bindtap="onTabSwitch" data-tab="completed">
      å·²å®Œæˆ
    </view>
  </view>

  <!-- Order List -->
  <scroll-view scroll-y class="order-list">
    <block wx:if="{{orders.length > 0}}">
      <view class="order-card" wx:for="{{orders}}" wx:key="_id">
        <!-- Order Header -->
        <view class="order-header">
          <image class="avatar" src="{{item.created_by.avatar_url || '/images/default-avatar.png'}}" mode="aspectFill" />
          <view class="order-info">
            <text class="username">{{item.created_by.nickname}}</text>
            <text class="time">{{utils.formatTime(item.created_at)}}</text>
          </view>
          <view class="status-badge status-{{item.status}}">
            <block wx:if="{{item.status === 'pending'}}">å¾…æ¥å•</block>
            <block wx:elif="{{item.status === 'cooking'}}">çƒ¹é¥ªä¸­</block>
            <block wx:elif="{{item.status === 'ready'}}">å¼€é¥­å•¦</block>
            <block wx:else>å·²å®Œæˆ</block>
          </view>
        </view>

        <!-- Order Items -->
        <view class="order-items">
          <view class="item-row" wx:for="{{item.items}}" wx:for-item="dish" wx:key="index">
            <text class="dish-name">{{dish.name}}</text>
            <text class="dish-qty">x{{dish.quantity}}</text>
            <text class="dish-price">Â¥{{dish.price / 100}}</text>
          </view>
        </view>

        <!-- Total -->
        <view class="order-total">
          åˆè®¡: <text class="amount">Â¥{{item.total_price / 100}}</text>
        </view>

        <!-- Praise Display (if exists) -->
        <view wx:if="{{item.praise && item.praise.content}}" class="praise-section">
          <view class="praise-header">ğŸŒˆ å½©è™¹å±</view>
          <view class="praise-content">{{item.praise.content}}</view>
          <view class="praise-author">â€” {{item.praise.nickname}}</view>
        </view>

        <!-- Review Display (if exists) -->
        <view wx:if="{{item.review && item.review.rating}}" class="review-section">
          <view class="review-header">â­ è¯„åˆ†: {{item.review.rating}}/5</view>
          <view wx:if="{{item.review.comment}}" class="review-comment">{{item.review.comment}}</view>
        </view>

        <!-- Actions (Role-Based) -->
        <view class="order-actions">
          <!-- Chef Actions -->
          <block wx:if="{{userRole === 'chef'}}">
            <button wx:if="{{item.status === 'pending'}}" class="btn-action btn-primary" bindtap="onAcceptOrder" data-id="{{item._id}}">
              æ¥å•åšèœ
            </button>
            <button wx:if="{{item.status === 'cooking'}}" class="btn-action btn-success" bindtap="onCallForDinner" data-id="{{item._id}}">
              å–Šåƒé¥­
            </button>
            <!-- Delete button for any status -->
            <button class="btn-action btn-danger" bindtap="onDeleteOrder" data-id="{{item._id}}">
              åˆ é™¤
            </button>
          </block>

          <!-- Foodie Actions -->
          <block wx:else>
            <button wx:if="{{item.status === 'pending'}}" class="btn-action btn-ghost" disabled>
              ç­‰å¾…å¤§å¨æ¥å•...
            </button>
            <button wx:if="{{item.status === 'cooking'}}" class="btn-action btn-outline" bindtap="onUrgeOrder" data-id="{{item._id}}">
              å‚¬å•
            </button>
            <button wx:if="{{item.status === 'ready'}}" class="btn-action btn-primary" bindtap="onSubmitReview" data-id="{{item._id}}">
              è¯„ä»· & å½©è™¹å±
            </button>
          </block>
        </view>
      </view>
    </block>

    <!-- Empty State -->
    <view wx:else class="empty-state">
      <text class="empty-icon">ğŸ½ï¸</text>
      <text class="empty-text">è¿˜æ²¡æœ‰ä»»ä½•åŠ¨æ€</text>
      <text class="empty-hint">å¿«å»å¨æˆ¿ç‚¹é¤å§~</text>
    </view>
  </scroll-view>

</view>
